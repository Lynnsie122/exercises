<!doctype html>
<html lang="zh-CN">
<head>
  <meta charset="utf-8" />
  <title>算法刷题记录本
</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <style>
    :root{
      --primary:#1abc9c; --primary-dark:#16a085; --accent:#3498db;
      --danger:#e74c3c; --bg:#f5f7fb; --card-bg:#ffffff; --text-main:#23303a;
      --text-sub:#60707a; --border:#e6eef2; --radius:12px; --shadow:0 12px 30px rgba(15,35,52,0.06);
    }
    *{box-sizing:border-box;margin:0;padding:0}
    html,body{height:100%}
    body{
      font-family:Inter,"Segoe UI",Roboto,"PingFang SC","Microsoft YaHei",Arial,sans-serif;
      background:linear-gradient(180deg,#f7fbfc 0%,#ffffff 100%); color:var(--text-main); font-size:15px; line-height:1.6;
      padding-bottom:40px;
    }
    header{position:sticky;top:0;z-index:50;background:rgba(255,255,255,0.96);backdrop-filter:blur(6px);box-shadow:0 2px 10px rgba(10,20,30,0.03);}
    .nav{max-width:1200px;margin:10px auto;padding:12px 18px;display:flex;align-items:center;gap:18px;justify-content:space-between;}
    .brand{display:flex;gap:12px;align-items:center}
    .brand-logo{width:48px;height:48px;border-radius:10px;background:linear-gradient(135deg,var(--primary),var(--primary-dark));display:flex;align-items:center;justify-content:center;color:#fff;font-weight:900;font-size:20px}
    .brand-text-title{font-weight:900}
    .nav-links{display:flex;gap:8px;align-items:center}
    .nav-btn{border:none;background:transparent;padding:9px 16px;border-radius:999px;color:var(--text-sub);cursor:pointer;font-weight:700;font-size:14px}
    .nav-btn.active{background:#fff;color:var(--primary-dark);box-shadow:0 6px 18px rgba(22,160,133,0.12);border:1px solid rgba(26,188,156,0.12)}
    main{max-width:1200px;margin:18px auto;padding:0 18px;}
    .card{background:var(--card-bg);border-radius:16px;padding:16px;box-shadow:var(--shadow);border:1px solid rgba(255,255,255,0.9);}
    .section{display:none}
    .section.active{display:block}
    .section-header{display:flex;justify-content:space-between;align-items:flex-start;gap:10px;margin-bottom:14px;flex-wrap:wrap}
    .section-title{font-size:20px;font-weight:900}
    .section-sub{font-size:13px;color:var(--text-sub)}
    .btn-primary{border:none;border-radius:999px;padding:9px 16px;background:linear-gradient(135deg,var(--primary),var(--primary-dark));color:#fff;font-size:14px;cursor:pointer;font-weight:700;display:inline-flex;align-items:center;gap:8px}
    .btn-outline{border-radius:999px;padding:8px 14px;background:transparent;border:1px dashed var(--border);color:var(--text-sub);font-size:13px;cursor:pointer;display:inline-flex;align-items:center;gap:6px}
    .btn-danger{background:rgba(231,76,60,0.12);color:#c0392b;border-radius:999px;padding:8px 12px;border:none;font-size:14px;cursor:pointer}
    .btn-sm{border-radius:999px;border:1px solid rgba(148,163,184,0.7);background:transparent;color:#0f172a;padding:7px 12px;font-size:13px;cursor:pointer}
    .home-grid{display:grid;grid-template-columns:2.2fr 1.3fr;gap:18px;margin-bottom:12px}
    .input, textarea, select{border-radius:999px;border:1px solid var(--border);padding:9px 12px;font-size:14px;outline:none;background:#f8fafc}
    textarea{border-radius:10px;resize:vertical;min-height:80px}
    .input:focus, textarea:focus, select:focus{border-color:var(--primary);box-shadow:0 0 0 1px rgba(26,188,156,0.12);background:#fff}
    .problem-table{width:100%;border-collapse:collapse;font-size:14px;margin-top:8px}
    .problem-table th,.problem-table td{padding:10px 8px;border-bottom:1px dashed #edf1f5;text-align:left;vertical-align:middle}
    .problem-table th{font-size:12px;letter-spacing:0.04em;text-transform:uppercase;color:var(--text-sub)}
    .problem-row{cursor:pointer}
    .tag{display:inline-block;padding:4px 9px;border-radius:999px;background:#ecf5ff;color:#2469d9;font-size:13px;margin-right:6px}
    .difficulty-easy{color:#27ae60;font-weight:700;font-size:14px}
    .difficulty-medium{color:#f39c12;font-weight:700;font-size:14px}
    .difficulty-hard{color:#e74c3c;font-weight:700;font-size:14px}
    /* detail */
    #detailSection{display:none}
    #detailSection.active{display:block}
    .detail-top{display:flex;justify-content:space-between;align-items:center;gap:12px;margin-bottom:12px}
    .detail-title-big{font-size:20px;font-weight:900}
    .detail-panel{border-radius:12px;padding:12px;background:linear-gradient(180deg,#ffffff 0,#f7fbfc 100%);box-shadow:var(--shadow);border:1px solid rgba(255,255,255,0.9)}
    .detail-body{display:grid;grid-template-columns:1.2fr 1fr;gap:0;margin-top:12px}
    .detail-col{padding:14px;overflow:auto}
    .detail-col-left{border-right:1px solid rgba(226,232,240,0.9);background:radial-gradient(circle at top,#ffffff 0,#f3f6fb 80%)}
    .detail-col-right{background:#ffffff;color:#0f172a;border-radius:10px}
    .detail-section{margin-bottom:12px;padding:10px;border-radius:10px;background:rgba(255,255,255,0.95);border:1px solid rgba(226,232,240,0.9)}
    .detail-section-title{font-size:15px;font-weight:800;margin-bottom:8px;color:#4b5563;display:flex;align-items:center;justify-content:space-between}
    .code-area-wrap{border-radius:10px;background:#ffffff;border:1px solid rgba(226,232,240,0.9);overflow:hidden;box-shadow:0 6px 18px rgba(15,23,42,0.04)}
    .code-toolbar{display:flex;justify-content:space-between;align-items:center;padding:10px 12px;background:#fbfdff;font-size:13px;color:#6b7280;border-bottom:1px solid rgba(240,245,250,0.9)}
    .code-textarea{width:100%;min-height:220px;background:#ffffff;border:none;color:#0f172a;padding:12px;font-family:Menlo,Consolas,"Fira Code",monospace;font-size:14px;line-height:1.5;white-space:pre;resize:vertical;outline:none}
    /* calendar */
    .calendar-wrap{display:flex;gap:16px;align-items:flex-start;flex-wrap:wrap}
    .calendar-card{width:420px;padding:12px;border-radius:12px;background:linear-gradient(180deg,#fff,#fbfeff);box-shadow:var(--shadow)}
    .cal-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:8px}
    .cal-grid{display:grid;grid-template-columns:repeat(7,1fr);gap:6px}
    .cal-week{font-size:13px;color:var(--text-sub);text-align:center;padding:6px 4px}
    .cal-day{min-height:52px;border-radius:8px;padding:6px;background:#f8fbfc;text-align:left;font-size:14px;position:relative;cursor:pointer}
    .cal-day.today{border:1px solid rgba(26,188,156,0.12)}
    .date-num{font-weight:700}
    .dot{width:8px;height:8px;border-radius:999px;background:var(--accent);display:inline-block;margin-right:4px}
    .cal-list{flex:1;min-width:300px;max-width:520px;padding:12px;border-radius:12px;background:linear-gradient(180deg,#fff,#fbfeff);box-shadow:var(--shadow)}
    /* notebooks */
    .notebooks-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(220px,1fr));gap:12px;margin-bottom:12px}
    .nb-card{background:#fff;border-radius:10px;padding:12px;border:1px solid rgba(226,232,240,0.9)}
    .nb-title{font-weight:800;margin-bottom:6px}
    .nb-desc{color:var(--text-sub);font-size:13px;margin-bottom:8px}
    .nb-tags{margin-bottom:8px}
    .toc-item{padding:6px;border-radius:6px;cursor:pointer}
    .toc-h1{font-weight:800}
    .toc-h2{padding-left:6px}
    .toc-h3{padding-left:12px;font-size:13px}
    .notes-main-wrap{display:flex;gap:12px}
    .notes-toc{width:220px}
    .notes-editor{flex:1}
    .notes-edit-area{display:flex;gap:12px}
    .notes-input{width:100%;min-height:360px;border-radius:10px;padding:12px;font-family:Menlo,Consolas,monospace}
    .notes-render{width:100%;min-height:360px;border-radius:10px;padding:12px;background:#fbfdff;border:1px solid rgba(240,245,250,0.9);overflow:auto}
    /* resources */
    .resources-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(240px,1fr));gap:12px}
    .res-card{background:#fff;border-radius:10px;padding:12px;border:1px solid rgba(226,232,240,0.9)}
    .res-title{font-weight:800;margin-bottom:6px}
    .res-desc{color:var(--text-sub);font-size:13px;margin-bottom:8px}
    .res-url{font-size:13px;color:var(--accent);margin-bottom:8px}
    .res-actions{display:flex;gap:8px}
    /* small util */
    .flex-row{display:flex;gap:8px;align-items:center}
  </style>
</head>
<body>
<header>
  <div class="nav">
    <div class="brand">
      <div class="brand-logo">Lyn</div>
      <div>
        <div class="brand-text-title">算法笔记本</div>
        <div class="brand-text-sub">记录题目 / 笔记 / 资源</div>
      </div>
    </div>
    <div class="nav-links">
      <button class="nav-btn active" data-section="home">题目</button>
      <button class="nav-btn" data-section="calendar">日历</button>
      <button class="nav-btn" data-section="notes">笔记</button>
      <button class="nav-btn" data-section="resources">资源</button>
      <button id="btnExport" class="btn-outline">导出</button>
      <input id="importFileInput" type="file" style="display:none" />
      <button id="btnImport" class="btn-outline">导入</button>
    </div>
  </div>
</header>

<main>
  <!-- Home -->
  <section id="home" class="section active">
    <div class="card">
      <div class="section-header">
        <div>
          <div class="section-title">题目列表</div>
          <div class="section-sub">记录你的刷题进度，点击“新建题目”开始。</div>
        </div>
        <div style="display:flex;gap:8px;align-items:center">
          <button id="btnAddProblem" class="btn-primary">＋ 新建题目</button>
        </div>
      </div>

      <div style="margin-bottom:12px;display:flex;gap:8px;align-items:center;">
        <input id="searchInput" class="input" placeholder="搜索标题 / 来源 / 标签" style="flex:1" />
        <select id="filterDifficulty" class="input" style="width:140px;">
          <option value="">难度：全部</option>
          <option>简单</option><option>中等</option><option>困难</option>
        </select>
        <select id="filterTag" class="input" style="width:160px;">
          <option value="">标签：全部</option>
        </select>
        <button id="btnExport" class="btn-outline">导出</button>
      </div>

      <table class="problem-table">
        <thead><tr><th>标题</th><th>来源</th><th>难度</th><th>标签</th><th>状态</th><th>操作</th></tr></thead>
        <tbody id="problemTbody"></tbody>
      </table>
    </div>
  </section>

  <!-- Detail -->
  <section id="detailSection" class="section">
    <div class="card detail-panel">
      <div class="detail-top">
        <div>
          <div id="detailPageTitle" class="detail-title-big">(未命名题目)</div>
          <div style="color:var(--text-sub);margin-top:6px" id="detailMetaRow">来源 · 难度 · 标签</div>
        </div>
        <div style="display:flex;gap:8px;align-items:center;">
          <button id="btnBackToList" class="btn-outline">← 返回</button>
          <button id="btnDeleteProblemPage" class="btn-danger">删除</button>
        </div>
      </div>

      <div class="detail-body">
        <div class="detail-col detail-col-left">
          <div class="detail-section">
            <div class="detail-section-title">基本信息
              <div class="pill-small" id="codeLangTag">C++</div>
            </div>
            <input id="detailInputTitle" class="input" placeholder="题目标题" style="width:100%;margin-bottom:8px;border-radius:8px"/>
            <div style="display:flex;gap:8px;margin-bottom:8px">
              <input id="detailInputSource" class="input" placeholder="来源（如：LeetCode）" />
              <select id="detailInputDifficulty" class="input">
                <option value="">难度</option><option>简单</option><option>中等</option><option>困难</option>
              </select>
              <select id="detailInputStatus" class="input">
                <option>未做</option><option>进行中</option><option>已做</option><option>需复习</option><option>已掌握</option>
              </select>
            </div>
            <label>标签（逗号分隔，可从下拉选择）：
              <input id="detailInputTags" class="input" list="tagsDatalist" style="width:100%;margin-top:6px;border-radius:8px;" placeholder="如：二分, 动态规划, 图" />
              <datalist id="tagsDatalist"></datalist>
            </label>
            <label style="display:block;margin-top:8px">关联日期（yyyy/mm/dd，非必填）：
              <input id="detailInputDate" type="text" class="input" style="width:100%;margin-top:6px;border-radius:8px;" placeholder="2025/12/04" />
            </label>
          </div>

          <div class="detail-section">
            <div class="detail-section-title">核心思路</div>
            <textarea id="detailInputIdea" placeholder="简要写一下题目的解题思路、关键转化、时间/空间复杂度等..." style="width:100%;min-height:120px;border-radius:8px;padding:10px;"></textarea>
          </div>

          <div class="detail-section">
            <div class="detail-section-title">易错点 / 细节</div>
            <textarea id="detailInputPitfalls" placeholder="记录容易犯错的边界情况、特殊样例、实现细节等..." style="width:100%;min-height:100px;border-radius:8px;padding:10px;"></textarea>
          </div>

          <div class="detail-section">
            <div style="display:flex;justify-content:space-between;align-items:center;">
              <div>加入笔记本</div>
              <div style="display:flex;gap:8px;align-items:center">
                <select id="addToNbSelect" class="input" style="width:180px;">
                  <option value="">选择笔记本</option>
                </select>
                <button id="btnAddToNotebook" class="btn-primary">加入</button>
              </div>
            </div>
            <div style="margin-top:8px;color:var(--text-sub);font-size:13px">会在笔记本末尾插入题目标题与链接（本地笔记）；不修改原笔记本内容结构。</div>
          </div>
        </div>

        <div class="detail-col detail-col-right">
          <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px;">
            <div style="color:#6b7280;font-size:14px;">代码记录（白底）</div>
            <select id="detailInputLang" class="input" style="border-radius:999px;padding:6px 10px;background:#ffffff;color:#0f172a;border:1px solid rgba(226,232,240,0.9);width:auto;">
              <option value="cpp">C++</option>
              <option value="java">Java</option>
              <option value="python">Python</option>
              <option value="go">Go</option>
              <option value="js">JavaScript</option>
            </select>
          </div>
          <div class="code-area-wrap" style="padding:6px;">
            <div class="code-toolbar">
              <div style="display:flex;gap:8px;align-items:center;">
                <span style="width:10px;height:10px;border-radius:999px;background:#f87171;display:inline-block"></span>
                <span style="width:10px;height:10px;border-radius:999px;background:#facc15;display:inline-block"></span>
                <span style="width:10px;height:10px;border-radius:999px;background:#22c55e;display:inline-block"></span>
                <span>在这里保存你对这道题的解法代码（支持 Tab 缩进）</span>
              </div>
              <div style="color:#6b7280;font-size:13px;" id="codeLangTag">C++</div>
            </div>
            <textarea id="detailInputCode" class="code-textarea" spellcheck="false" placeholder="// 在这里写你的代码"></textarea>
          </div>

          <div style="display:flex;justify-content:space-between;align-items:center;margin-top:12px;">
            <div style="font-size:13px;color:#9ca3af;">所有修改会自动保存到本地 localStorage（无需手动保存）。</div>
            <div style="display:flex;gap:8px;">
              <button id="btnMarkReview" class="btn-sm">标记为需复习</button>
              <button id="btnMarkMastered" class="btn-sm">标记为已掌握</button>
            </div>
          </div>
        </div>
      </div>

    </div>
  </section>

  <!-- Calendar -->
  <section id="calendar" class="section">
    <div class="card">
      <div class="section-header">
        <div>
          <div class="section-title">刷题日历</div>
          <div class="section-sub">按日期查看当天关联的题目（在题目详情填写“关联日期”以在日历中显示）。</div>
        </div>
      </div>

      <div class="calendar-wrap">
        <div class="calendar-card card" id="calendarCard">
          <div class="cal-header">
            <div style="font-weight:800" id="calMonthLabel">2025 年 12 月</div>
            <div style="display:flex;gap:8px">
              <button id="calPrev" class="btn-outline">上月</button>
              <button id="calNext" class="btn-outline">下月</button>
            </div>
          </div>
          <div class="cal-grid" id="calGridHeader">
            <div class="cal-week">周日</div><div class="cal-week">周一</div><div class="cal-week">周二</div><div class="cal-week">周三</div><div class="cal-week">周四</div><div class="cal-week">周五</div><div class="cal-week">周六</div>
          </div>
          <div class="cal-grid" id="calGridDays"></div>
        </div>

        <div class="cal-list card" id="calList">
          <div style="font-weight:800;margin-bottom:8px;" id="calListLabel">选中日期：无</div>
          <div id="calItems">请选择左侧日历的某一天以查看关联题目。</div>
        </div>
      </div>
    </div>
  </section>

  <!-- Notes / Notebooks -->
  <section id="notes" class="section">
    <div class="card">
      <div class="section-header" style="align-items:flex-start;">
        <div>
          <div class="section-title">笔记 / 笔记本</div>
          <div class="section-sub">创建多个笔记本，每个笔记本独立保存内容和目录。点击笔记本卡片进入编辑视图（左目录 / 右编辑 + 渲染）。</div>
        </div>
        <div style="display:flex;flex-direction:column;gap:8px;align-items:flex-end;">
          <div style="display:flex;gap:8px;">
            <input id="nbNewName" class="input" placeholder="笔记本名称" />
            <input id="nbNewTags" class="input" placeholder="标签（逗号分隔）" />
            <button id="btnCreateNb" class="btn-primary">新建笔记本</button>
            <!-- 搜索框移到新建按钮右侧（按你的要求） -->
            <input id="nbSearch" class="input" placeholder="搜索笔记本名称 / 标签" style="margin-left:12px;" />
            <button id="btnRefreshNbs" class="btn-outline">刷新</button>
          </div>
        </div>
      </div>

      <div id="notebooksListWrap">
        <div class="notebooks-grid" id="notebooksGrid"></div>
      </div>

      <!-- Notebook editor -->
      <div id="notebookEditorWrap" style="margin-top:12px;display:none;">
        <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:10px;">
          <div style="display:flex;gap:12px;align-items:center;">
            <button id="btnBackToNbs" class="btn-sm">← 返回笔记本列表</button>
            <div style="font-weight:800" id="nbEditorTitle">笔记本 - 名称</div>
            <div style="color:var(--text-sub)" id="nbEditorTags"></div>
          </div>
          <div style="display:flex;gap:8px;">
            <button id="btnDeleteNb" class="btn-danger">删除笔记本</button>
            <button id="btnExportNb" class="btn-outline">导出笔记本</button>
          </div>
        </div>

        <div class="notes-main-wrap">
          <div class="notes-toc" id="notesToc">
            <div style="font-weight:800;margin-bottom:8px">目录</div>
            <div id="tocList" style="display:flex;flex-direction:column;gap:6px"></div>
            <div style="margin-top:12px;font-size:13px;color:var(--text-sub)">点击目录可在编辑器中插入该标题或跳转渲染区（编辑器较长时）。</div>
          </div>

          <div class="notes-editor">
            <div class="toolbar" style="display:flex;gap:8px;margin-bottom:8px">
              <button id="btnInsertH1" class="btn-outline">H1</button>
              <button id="btnInsertH2" class="btn-outline">H2</button>
              <button id="btnInsertH3" class="btn-outline">H3</button>
              <button id="btnClearNotes" class="btn-outline">清空</button>
              <div style="flex:1"></div>
              <div style="font-size:13px;color:var(--text-sub)">自动保存到本地</div>
            </div>

            <div class="notes-edit-area">
              <textarea id="notesInput" class="notes-input" spellcheck="false" placeholder="# 标题示例\n## 子标题\n在这里写你的笔记，支持简单的 Markdown 标题、代码块和换行。"></textarea>
              <div class="notes-render" id="notesRender"></div>
            </div>
          </div>
        </div>
      </div>

    </div>
  </section>

  <!-- Resources -->
  <section id="resources" class="section">
    <div class="card">
      <div class="section-header">
        <div>
          <div class="section-title">常用资源 / 链接</div>
          <div class="section-sub">整理常用题单、博客、文档链接，卡片式展示并支持添加/删除/编辑。</div>
        </div>
        <div>
          <button id="btnAddResource" class="btn-primary">＋ 添加资源</button>
        </div>
      </div>

      <div style="margin-bottom:12px;display:flex;gap:8px;align-items:center;">
        <input id="resTitle" class="input" placeholder="资源标题" style="flex:1" />
        <input id="resUrl" class="input" placeholder="链接（可选）" style="flex:1" />
        <input id="resDesc" class="input" placeholder="描述（可多行）" style="flex:2" />
      </div>

      <div class="resources-grid" id="resourcesGrid"></div>
    </div>
  </section>

</main>

<script>
  // Storage keys
  const STORAGE_KEY = "algo_problems_v2";
  const RES_KEY = "algo_resources_v2";
  const NOTEBOOKS_KEY = "algo_notebooks_v1";

  let problems = [];
  let resources = [];
  let notebooks = [];

  // Elements
  const tbody = document.getElementById("problemTbody");
  const searchInput = document.getElementById("searchInput");
  const filterDifficulty = document.getElementById("filterDifficulty");
  const filterTag = document.getElementById("filterTag");
  const tagsDatalist = document.getElementById("tagsDatalist");

  const detailSection = document.getElementById("detailSection");
  const detailPageTitle = document.getElementById("detailPageTitle");
  const detailMetaRow = document.getElementById("detailMetaRow");
  const detailInputTitle = document.getElementById("detailInputTitle");
  const detailInputSource = document.getElementById("detailInputSource");
  const detailInputDifficulty = document.getElementById("detailInputDifficulty");
  const detailInputTags = document.getElementById("detailInputTags");
  const detailInputStatus = document.getElementById("detailInputStatus");
  const detailInputIdea = document.getElementById("detailInputIdea");
  const detailInputPitfalls = document.getElementById("detailInputPitfalls");
  const detailInputLang = document.getElementById("detailInputLang");
  const detailInputCode = document.getElementById("detailInputCode");
  const codeLangTag = document.getElementById("codeLangTag");
  const detailInputDate = document.getElementById("detailInputDate");
  const btnBackToList = document.getElementById("btnBackToList");
  const btnDeleteProblemPage = document.getElementById("btnDeleteProblemPage");
  const btnMarkReview = document.getElementById("btnMarkReview");
  const btnMarkMastered = document.getElementById("btnMarkMastered");
  const addToNbSelect = document.getElementById("addToNbSelect");
  const btnAddToNotebook = document.getElementById("btnAddToNotebook");

  // Notebooks elements
  const notebooksGrid = document.getElementById("notebooksGrid");
  const nbNewName = document.getElementById("nbNewName");
  const nbNewTags = document.getElementById("nbNewTags");
  const btnCreateNb = document.getElementById("btnCreateNb");
  const nbSearch = document.getElementById("nbSearch");
  const btnRefreshNbs = document.getElementById("btnRefreshNbs");
  const notebookEditorWrap = document.getElementById("notebookEditorWrap");
  const notebooksListWrap = document.getElementById("notebooksListWrap");
  const nbEditorTitle = document.getElementById("nbEditorTitle");
  const nbEditorTags = document.getElementById("nbEditorTags");
  const btnBackToNbs = document.getElementById("btnBackToNbs");
  const btnDeleteNb = document.getElementById("btnDeleteNb");
  const btnExportNb = document.getElementById("btnExportNb");
  const notesInput = document.getElementById("notesInput");
  const notesRender = document.getElementById("notesRender");
  const tocList = document.getElementById("tocList");
  const btnInsertH1 = document.getElementById("btnInsertH1");
  const btnInsertH2 = document.getElementById("btnInsertH2");
  const btnInsertH3 = document.getElementById("btnInsertH3");
  const btnClearNotes = document.getElementById("btnClearNotes");

  // Resources
  const resourcesGrid = document.getElementById("resourcesGrid");
  const resTitle = document.getElementById("resTitle");
  const resUrl = document.getElementById("resUrl");
  const resDesc = document.getElementById("resDesc");
  const btnAddResource = document.getElementById("btnAddResource");

  // Calendar
  const calGridDays = document.getElementById("calGridDays");
  const calMonthLabel = document.getElementById("calMonthLabel");
  const calPrev = document.getElementById("calPrev");
  const calNext = document.getElementById("calNext");
  const calListLabel = document.getElementById("calListLabel");
  const calItems = document.getElementById("calItems");
  let calDate = new Date(); calDate.setDate(1);

  // State
  let currentProblemId = null;
  let currentNotebookId = null;
  let notesTimer = null;

  // Load / Save
  function loadData(){
    try{ const raw = localStorage.getItem(STORAGE_KEY); if(raw) problems = JSON.parse(raw); }catch(e){ problems=[]; }
    try{ const r = localStorage.getItem(RES_KEY); if(r) resources = JSON.parse(r); }catch(e){ resources=[]; }
    try{ const nb = localStorage.getItem(NOTEBOOKS_KEY); if(nb) notebooks = JSON.parse(nb); }catch(e){ notebooks=[]; }
  }
  function saveProblems(){ localStorage.setItem(STORAGE_KEY, JSON.stringify(problems)); renderProblemTable(); updateCalendar(); populateTagsDatalist(); updateAddToNbOptions(); }
  function saveResources(){ localStorage.setItem(RES_KEY, JSON.stringify(resources)); renderResources(); }
  function saveNotebooks(){ localStorage.setItem(NOTEBOOKS_KEY, JSON.stringify(notebooks)); renderNotebooksGrid(); updateAddToNbOptions(); }

  // Utilities
  function formatYYYYMMDD(d){ const y=d.getFullYear(); const m=('0'+(d.getMonth()+1)).slice(-2); const day=('0'+d.getDate()).slice(-2); return `${y}-${m}-${day}`; }
  function displayToIso(display){ if(!display) return null; const s=display.trim().replace(/-/g,'/'); const m=s.match(/^(\d{4})\/(\d{1,2})\/(\d{1,2})$/); if(!m) return null; const y=+m[1], mo=+m[2], dd=+m[3]; if(mo<1||mo>12||dd<1||dd>31) return null; return `${y}-${('0'+mo).slice(-2)}-${('0'+dd).slice(-2)}`; }
  function isoToDisplay(iso){ if(!iso) return ""; const m=iso.match(/^(\d{4})-(\d{2})-(\d{2})$/); if(!m) return iso; return `${m[1]}/${m[2]}/${m[3]}`; }
  function escapeHtml(s){ return (s||'').replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;'); }

  // Tags
  function collectAllTags(){ const set=new Set(); for(const p of problems){ (p.tags||[]).forEach(t=>t&&set.add(t)); } return Array.from(set).sort(); }
  function populateTagsDatalist(){ const tags = collectAllTags(); tagsDatalist.innerHTML=''; tags.forEach(t=>{ const opt=document.createElement('option'); opt.value=t; tagsDatalist.appendChild(opt); }); updateTagFilters(); }
  function updateTagFilters(){ const tags=collectAllTags(); const sel=document.getElementById('filterTag'); const prev=sel.value; sel.innerHTML='<option value="">标签：全部</option>'; tags.forEach(t=>{ const o=document.createElement('option'); o.value=t; o.textContent=t; sel.appendChild(o); }); if(prev) sel.value=prev; }

  // Problems list rendering
  function difficultyClass(d){ if(d==="简单") return "difficulty-easy"; if(d==="中等") return "difficulty-medium"; if(d==="困难") return "difficulty-hard"; return ""; }
  function renderProblemTable(){
    const q=(searchInput.value||'').trim().toLowerCase(); const diff=filterDifficulty.value; const tagFilter=filterTag.value;
    tbody.innerHTML='';
    const list = problems.filter(p=>{
      if(diff && p.difficulty!==diff) return false;
      if(tagFilter && !(p.tags && p.tags.includes(tagFilter))) return false;
      if(!q) return true;
      const text = [p.title||'',p.source||'',(p.tags||[]).join(',')].join(' ').toLowerCase();
      return text.includes(q);
    }).sort((a,b)=>(b.updatedAt||0)-(a.updatedAt||0));
    if(!list.length){
      const tr=document.createElement('tr'); const td=document.createElement('td'); td.colSpan=6; td.style.textAlign='center'; td.style.padding='22px 0'; td.style.color='var(--text-sub)'; td.innerText='暂无题目，点击“新建题目”开始记录。'; tr.appendChild(td); tbody.appendChild(tr); return;
    }
    list.forEach(p=>{
      const tr=document.createElement('tr'); tr.className='problem-row'; tr.dataset.id=p.id;
      const tdTitle=document.createElement('td'); tdTitle.innerHTML='<strong>'+escapeHtml(p.title||'(未命名题目)')+'</strong>';
      const tdSource=document.createElement('td'); tdSource.textContent=p.source||'-';
      const tdDiff=document.createElement('td'); tdDiff.innerHTML='<span class="'+difficultyClass(p.difficulty)+'">'+(p.difficulty||'-')+'</span>';
      const tdTags=document.createElement('td'); (p.tags||[]).forEach(t=>{ if(!t) return; const span=document.createElement('span'); span.className='tag'; span.textContent=t; tdTags.appendChild(span); }); if(!(p.tags||[]).length) tdTags.textContent='-';
      const tdStatus=document.createElement('td'); tdStatus.textContent=p.status||'未做';
      const tdOps=document.createElement('td'); const btnEdit=document.createElement('button'); btnEdit.textContent='打开'; btnEdit.className='btn-outline'; btnEdit.style.fontSize='13px'; btnEdit.addEventListener('click',(e)=>{ e.stopPropagation(); openDetailPage(p.id); }); tdOps.appendChild(btnEdit);
      tr.appendChild(tdTitle); tr.appendChild(tdSource); tr.appendChild(tdDiff); tr.appendChild(tdTags); tr.appendChild(tdStatus); tr.appendChild(tdOps);
      tr.addEventListener('click',()=>openDetailPage(p.id));
      tbody.appendChild(tr);
    });
  }

  // Create problem
  document.getElementById('btnAddProblem').addEventListener('click',()=>{
    const id = Date.now().toString(36)+Math.random().toString(36).slice(2,6); const now=Date.now();
    const p={ id, title:'新题目', source:'LeetCode', difficulty:'', tags:[], status:'未做', idea:'', pitfalls:'', lang:'cpp', code:'', date:null, createdAt:now, updatedAt:now };
    problems.push(p); saveProblems(); openDetailPage(id); switchSection('detail');
  });

  // Export / Import
  document.getElementById('btnExport').addEventListener('click',()=>{
    const data={ version:1, exportedAt:new Date().toISOString(), problems, notebooks, resources };
    const blob=new Blob([JSON.stringify(data,null,2)],{type:'application/json'}); const url=URL.createObjectURL(blob);
    const a=document.createElement('a'); a.href=url; a.download='algo_data_backup_'+Date.now()+'.json'; a.click(); URL.revokeObjectURL(url);
  });
  document.getElementById('btnImport').addEventListener('click',()=>document.getElementById('importFileInput').click());
  document.getElementById('importFileInput').addEventListener('change',(e)=>{
    const file=e.target.files[0]; if(!file) return; const reader=new FileReader();
    reader.onload=ev=>{ try{ const data=JSON.parse(ev.target.result); if(!data||typeof data!=='object'){ alert('文件格式不符合预期。'); return; } if(confirm('导入数据将覆盖当前本地数据，是否继续？')){ problems=data.problems||problems; if(Array.isArray(data.notebooks)) notebooks=data.notebooks; if(Array.isArray(data.resources)) resources=data.resources; saveProblems(); saveNotebooks(); saveResources(); renderNotesListView(); renderResources(); alert('导入完成。'); } }catch(err){ alert('解析 JSON 失败：'+err.message); } };
    reader.readAsText(file); e.target.value='';
  });

  // Detail page open/close and binding
  function openDetailPage(id){
    const p = problems.find(x=>x.id===id); if(!p) return;
    currentProblemId = id;
    detailPageTitle.textContent = p.title || "(未命名题目)";
    detailMetaRow.textContent = `${p.source||'未设置来源'} · ${p.difficulty||'未设置难度'} · ${(p.tags||[]).join(' · ')||'未设置标签'}`;
    detailInputTitle.value = p.title||''; detailInputSource.value=p.source||''; detailInputDifficulty.value=p.difficulty||''; detailInputTags.value=(p.tags||[]).join(', '); detailInputStatus.value=p.status||'未做';
    detailInputIdea.value=p.idea||''; detailInputPitfalls.value=p.pitfalls||''; detailInputLang.value=p.lang||'cpp'; detailInputCode.value=p.code||''; codeLangTag.textContent = langLabel(p.lang||'cpp');
    detailInputDate.value = p.date ? isoToDisplay(p.date) : '';
    populateTagsDatalist();
    updateAddToNbOptions();
    switchSection('detail');
  }
  function closeDetailPage(){ currentProblemId=null; switchSection('home'); }

  btnBackToList.addEventListener('click', closeDetailPage);

  function langLabel(lang){ switch(lang){ case 'cpp': return 'C++'; case 'java': return 'Java'; case 'python': return 'Python'; case 'go': return 'Go'; case 'js': return 'JavaScript'; default: return lang||'代码'; } }

  function updateCurrentProblem(mutator){
    if(!currentProblemId) return;
    const idx = problems.findIndex(p=>p.id===currentProblemId); if(idx===-1) return;
    mutator(problems[idx]); problems[idx].updatedAt = Date.now(); saveProblems();
    updateDetailMetaFromCurrent();
  }
  function updateDetailMetaFromCurrent(){ const p = problems.find(x=>x.id===currentProblemId); if(!p) return; detailPageTitle.textContent = p.title||'(未命名题目)'; detailMetaRow.textContent = `${p.source||'未设置来源'} · ${p.difficulty||'未设置难度'} · ${(p.tags||[]).join(' · ')||'未设置标签'}`; codeLangTag.textContent = langLabel(p.lang||'cpp'); }

  // Bind inputs
  detailInputTitle.addEventListener('input',()=>{ const v=detailInputTitle.value; detailPageTitle.textContent=v||'(未命名题目)'; updateCurrentProblem(p=>p.title=v); });
  detailInputSource.addEventListener('input',()=>{ const v=detailInputSource.value; updateCurrentProblem(p=>p.source=v); });
  detailInputDifficulty.addEventListener('change',()=>{ const v=detailInputDifficulty.value; updateCurrentProblem(p=>p.difficulty=v); });
  detailInputTags.addEventListener('blur', processTagsInputAndSave);
  detailInputTags.addEventListener('keydown',(e)=>{ if(e.key==='Enter'){ e.preventDefault(); detailInputTags.blur(); } });
  function processTagsInputAndSave(){ const v=detailInputTags.value; const arr = v.split(',').map(x=>x.trim()).filter(Boolean); updateCurrentProblem(p=>p.tags=arr); populateTagsDatalist(); }
  detailInputStatus.addEventListener('change',()=>{ const v=detailInputStatus.value; updateCurrentProblem(p=>p.status=v); });
  detailInputIdea.addEventListener('input',()=>{ const v=detailInputIdea.value; updateCurrentProblem(p=>p.idea=v); });
  detailInputPitfalls.addEventListener('input',()=>{ const v=detailInputPitfalls.value; updateCurrentProblem(p=>p.pitfalls=v); });
  detailInputLang.addEventListener('change',()=>{ const v=detailInputLang.value; codeLangTag.textContent=langLabel(v); updateCurrentProblem(p=>p.lang=v); });
  detailInputCode.addEventListener('input',()=>{ const v=detailInputCode.value; updateCurrentProblem(p=>p.code=v); });

  // Code textarea support Tab indentation
  detailInputCode.addEventListener('keydown',(e)=>{
    if(e.key==='Tab'){
      e.preventDefault();
      const el = detailInputCode; const start = el.selectionStart, end = el.selectionEnd;
      if(!e.shiftKey){
        el.value = el.value.substring(0,start) + '\t' + el.value.substring(end);
        el.selectionStart = el.selectionEnd = start + 1;
      } else {
        // shift+tab remove a leading tab if exists at selection start
        const before = el.value.substring(0,start);
        if(before.endsWith('\t')){
          el.value = el.value.substring(0,start-1) + el.value.substring(end);
          el.selectionStart = el.selectionEnd = start - 1;
        }
      }
      updateCurrentProblem(p=>p.code=el.value);
    }
  });

  // Date binding
  detailInputDate.addEventListener('blur',()=>{
    const disp = detailInputDate.value.trim(); const iso = displayToIso(disp);
    if(iso){ updateCurrentProblem(p=>p.date=iso); updateCalendar(); }
    else if(disp===''){ updateCurrentProblem(p=>p.date=null); updateCalendar(); }
    else { alert('日期格式应为 yyyy/mm/dd（例如 2025/12/04）或清空以取消关联日期。'); detailInputDate.value=''; }
  });

  // Status quick buttons
  btnMarkReview.addEventListener('click',()=>{ detailInputStatus.value='需复习'; updateCurrentProblem(p=>p.status='需复习'); });
  btnMarkMastered.addEventListener('click',()=>{ detailInputStatus.value='已掌握'; updateCurrentProblem(p=>p.status='已掌握'); });
  btnDeleteProblemPage.addEventListener('click',()=>{ if(!currentProblemId) return; if(confirm('确定删除这道题目及其所有记录吗？')){ problems = problems.filter(p=>p.id!==currentProblemId); saveProblems(); closeDetailPage(); } });

  // Add to notebook: insert link + title at end
  function updateAddToNbOptions(){
    addToNbSelect.innerHTML = '<option value="">选择笔记本</option>';
    notebooks.forEach(nb=>{ const o=document.createElement('option'); o.value=nb.id; o.textContent = nb.name; addToNbSelect.appendChild(o); });
  }
  btnAddToNotebook.addEventListener('click',()=>{
    if(!currentProblemId) return alert('当前未打开题目');
    const nbId = addToNbSelect.value; if(!nbId) return alert('请选择目标笔记本');
    const nb = notebooks.find(x=>x.id===nbId); if(!nb) return alert('未找到笔记本');
    const p = problems.find(x=>x.id===currentProblemId); if(!p) return alert('未找到题目');
    const linkLine = `- [${p.title || '(未命名)'}](#problem:${p.id})  ${p.source ? `· ${p.source}` : ''}\n`;
    nb.content = (nb.content || '') + '\n' + linkLine;
    nb.updatedAt = Date.now();
    saveNotebooks();
    alert('已将题目加入笔记本：' + nb.name);
  });

  // Navigation
  function switchSection(name){
    document.querySelectorAll('.nav-btn').forEach(b=>b.classList.toggle('active', b.dataset.section===name));
    document.querySelectorAll('.section').forEach(sec=>sec.classList.remove('active'));
    if(name==='home') document.getElementById('home').classList.add('active');
    else if(name==='detail') document.getElementById('detailSection').classList.add('active');
    else document.getElementById(name).classList.add('active');
    if(name==='notes') renderNotesListView();
  }
  document.querySelectorAll('.nav-btn').forEach(btn=>btn.addEventListener('click',()=>switchSection(btn.dataset.section)));

  // Search & filter bindings
  searchInput.addEventListener('input', renderProblemTable);
  filterDifficulty.addEventListener('change', renderProblemTable);
  filterTag.addEventListener('change', renderProblemTable);

  // Calendar rendering
  function updateCalendar(){
    calGridDays.innerHTML='';
    const year = calDate.getFullYear(), month = calDate.getMonth();
    calMonthLabel.textContent = `${year} 年 ${month+1} 月`;
    const firstDay = new Date(year,month,1); const startWeek = firstDay.getDay();
    const daysInMonth = new Date(year, month+1, 0).getDate();
    for(let i=0;i<startWeek;i++){ const div=document.createElement('div'); div.className='cal-day'; div.style.background='transparent'; div.style.border='none'; calGridDays.appendChild(div); }
    const map = {};
    for(const p of problems) if(p.date) { (map[p.date] = map[p.date] || []).push(p); }
    const todayStr = formatYYYYMMDD(new Date());
    for(let d=1; d<=daysInMonth; d++){
      const dt = new Date(year, month, d); const iso = formatYYYYMMDD(dt);
      const div=document.createElement('div'); div.className='cal-day'+(iso===todayStr?' today':''); div.dataset.date=iso; div.innerHTML=`<div class="date-num">${d}</div>`;
      if(map[iso] && map[iso].length){
        const dotsWrap=document.createElement('div'); dotsWrap.style.position='absolute'; dotsWrap.style.right='6px'; dotsWrap.style.bottom='6px';
        for(let i=0;i<Math.min(3,map[iso].length);i++){ const dot=document.createElement('span'); dot.className='dot'; dot.title = map[iso][i].title; dot.style.background = i===0? 'var(--accent)' : (i===1? 'var(--primary)' : '#f39c12'); dotsWrap.appendChild(dot); }
        div.appendChild(dotsWrap);
      }
      div.addEventListener('click', ()=> onCalendarDateClick(iso));
      calGridDays.appendChild(div);
    }
  }
  function onCalendarDateClick(iso){
    calListLabel.textContent = `选中日期：${isoToDisplay(iso)}`;
    const list = problems.filter(p=>p.date===iso).sort((a,b)=>(b.updatedAt||0)-(a.updatedAt||0));
    if(!list.length){ calItems.innerHTML = `<div style="color:var(--text-sub)">该日期没有关联题目。可在题目详情中设置“关联日期”。</div>`; return; }
    calItems.innerHTML=''; list.forEach(p=>{ const row=document.createElement('div'); row.style.padding='8px 6px'; row.style.borderBottom='1px dashed rgba(230,238,242,0.9)';
      const title=document.createElement('div'); title.style.fontWeight=800; title.textContent=p.title||'(未命名)';
      const meta=document.createElement('div'); meta.style.fontSize='13px'; meta.style.color='var(--text-sub)'; meta.textContent=`${p.source||'-'} · ${p.difficulty||'-'} · ${p.status||'-'}`;
      const btn=document.createElement('button'); btn.className='btn-outline'; btn.style.marginTop='8px'; btn.textContent='打开'; btn.addEventListener('click',()=>openDetailPage(p.id));
      row.appendChild(title); row.appendChild(meta); row.appendChild(btn); calItems.appendChild(row);
    });
  }
  calPrev.addEventListener('click', ()=>{ calDate.setMonth(calDate.getMonth()-1); updateCalendar(); });
  calNext.addEventListener('click', ()=>{ calDate.setMonth(calDate.getMonth()+1); updateCalendar(); });

  // Resources rendering with edit support
  function renderResources(){
    resourcesGrid.innerHTML='';
    if(!resources.length){ resourcesGrid.innerHTML='<div style="color:var(--text-sub);padding:12px">暂无资源，使用上方表单添加常用链接/题单。</div>'; return; }
    resources.forEach((r, idx)=>{
      const card=document.createElement('div'); card.className='res-card';
      const title=document.createElement('div'); title.className='res-title'; title.textContent=r.title||'未命名';
      const desc=document.createElement('div'); desc.className='res-desc'; desc.textContent=r.desc||'';
      const urlDiv=document.createElement('div'); urlDiv.className='res-url';
      if(r.url){ const a=document.createElement('a'); a.href=r.url; a.target='_blank'; a.textContent=r.url; urlDiv.appendChild(a); }
      const actions=document.createElement('div'); actions.className='res-actions';
      if(r.url){ const a=document.createElement('a'); a.href=r.url; a.target='_blank'; a.className='btn-outline'; a.textContent='打开链接'; actions.appendChild(a); }
      const edit=document.createElement('button'); edit.className='btn-sm'; edit.textContent='编辑'; edit.addEventListener('click',()=>{
        const newTitle = prompt('修改资源标题：', r.title||''); if(newTitle===null) return;
        const newUrl = prompt('修改链接（可留空）：', r.url||'') || '';
        const newDesc = prompt('修改描述：', r.desc||'') || '';
        r.title = newTitle.trim() || r.title; r.url = newUrl.trim(); r.desc = newDesc; saveResources();
      });
      const del=document.createElement('button'); del.className='btn-danger'; del.textContent='删除'; del.addEventListener('click',()=>{
        if(confirm('删除该资源？')){ resources.splice(idx,1); saveResources(); }
      });
      actions.appendChild(edit); actions.appendChild(del);
      card.appendChild(title); card.appendChild(desc); card.appendChild(urlDiv); card.appendChild(actions);
      resourcesGrid.appendChild(card);
    });
  }
  btnAddResource.addEventListener('click', ()=>{
    const t = resTitle.value.trim(); const u = resUrl.value.trim(); const d = resDesc.value.trim();
    if(!t) return alert('请输入资源标题');
    resources.push({ title:t, url:u, desc:d, id:Date.now().toString(36) });
    resTitle.value=''; resUrl.value=''; resDesc.value='';
    saveResources();
  });

  // Notebooks / notes
  function renderNotebooksGrid(){
    const q=(nbSearch.value||'').trim().toLowerCase();
    notebooksGrid.innerHTML='';
    const list = notebooks.filter(nb=>{ if(!q) return true; return (nb.name||'').toLowerCase().includes(q) || (nb.tags||[]).join(' ').toLowerCase().includes(q) || (nb.desc||'').toLowerCase().includes(q); }).sort((a,b)=>(b.updatedAt||0)-(a.updatedAt||0));
    if(!list.length){ notebooksGrid.innerHTML='<div style="color:var(--text-sub);padding:12px">暂无笔记本，使用上方输入框创建一个。</div>'; return; }
    list.forEach(nb=>{
      const card=document.createElement('div'); card.className='nb-card';
      const title=document.createElement('div'); title.className='nb-title'; title.textContent=nb.name||'未命名';
      const desc=document.createElement('div'); desc.className='nb-desc'; desc.textContent=nb.desc||'';
      const tagsWrap=document.createElement('div'); tagsWrap.className='nb-tags'; (nb.tags||[]).forEach(t=>{ const s=document.createElement('span'); s.className='tag'; s.textContent=t; tagsWrap.appendChild(s); });
      const actions=document.createElement('div'); actions.style.display='flex'; actions.style.gap='8px';
      const open=document.createElement('button'); open.className='btn-outline'; open.textContent='打开'; open.addEventListener('click',()=>openNotebook(nb.id));
      const edit=document.createElement('button'); edit.className='btn-sm'; edit.textContent='编辑'; edit.addEventListener('click',()=>{
        const newName = prompt('修改笔记本名：', nb.name||''); if(newName===null) return;
        const newDesc = prompt('修改描述（可多行）：', nb.desc||'') || '';
        const newTags = prompt('标签（逗号分隔）：', (nb.tags||[]).join(', ')) || '';
        nb.name = newName.trim() || nb.name; nb.desc=newDesc; nb.tags=newTags.split(',').map(x=>x.trim()).filter(Boolean); nb.updatedAt=Date.now(); saveNotebooks();
      });
      const del=document.createElement('button'); del.className='btn-danger'; del.textContent='删除'; del.addEventListener('click',()=>{ if(confirm('删除该笔记本及其所有笔记（无法恢复）？')){ notebooks = notebooks.filter(x=>x.id!==nb.id); saveNotebooks(); if(currentNotebookId===nb.id) closeNotebookEditor(); } });
      actions.appendChild(open); actions.appendChild(edit); actions.appendChild(del);
      card.appendChild(title); card.appendChild(desc); card.appendChild(tagsWrap); card.appendChild(actions);
      card.addEventListener('dblclick', ()=> openNotebook(nb.id));
      notebooksGrid.appendChild(card);
    });
  }

  btnCreateNb.addEventListener('click', ()=>{
    const name = (nbNewName.value||'').trim(); if(!name) return alert('请输入笔记本名称');
    const tags = (nbNewTags.value||'').split(',').map(x=>x.trim()).filter(Boolean);
    const id = Date.now().toString(36)+Math.random().toString(36).slice(2,6); const now=Date.now();
    const nb = { id, name, desc:'', tags, content:'# '+name+'\n\n', createdAt:now, updatedAt:now };
    notebooks.push(nb); nbNewName.value=''; nbNewTags.value=''; saveNotebooks(); openNotebook(id);
  });
  btnRefreshNbs.addEventListener('click', renderNotebooksGrid);
  nbSearch.addEventListener('input', renderNotebooksGrid);

  function openNotebook(id){
    const nb = notebooks.find(x=>x.id===id); if(!nb) return;
    currentNotebookId = id; notebooksListWrap.style.display='none'; notebookEditorWrap.style.display='block';
    nbEditorTitle.textContent = nb.name; nbEditorTags.textContent = (nb.tags||[]).map(t=>'#'+t).join(' ');
    notesInput.value = nb.content || '';
    renderNotesForCurrentNotebook();
  }
  function closeNotebookEditor(){ currentNotebookId=null; notebooksListWrap.style.display='block'; notebookEditorWrap.style.display='none'; notesInput.value=''; notesRender.innerHTML=''; tocList.innerHTML=''; }
  btnBackToNbs.addEventListener('click', closeNotebookEditor);
  btnDeleteNb.addEventListener('click', ()=>{ if(!currentNotebookId) return; if(confirm('删除当前笔记本及其内容？')){ notebooks = notebooks.filter(x=>x.id!==currentNotebookId); saveNotebooks(); closeNotebookEditor(); }});
  btnExportNb.addEventListener('click', ()=>{ if(!currentNotebookId) return; const nb = notebooks.find(x=>x.id===currentNotebookId); if(!nb) return; const blob=new Blob([JSON.stringify(nb,null,2)],{type:'application/json'}); const url=URL.createObjectURL(blob); const a=document.createElement('a'); a.href=url; a.download=(nb.name||'notebook')+'_'+Date.now()+'.json'; a.click(); URL.revokeObjectURL(url); });

  // Simple markdown render & TOC
  function simpleMarkdownRender(md){
    const lines = md.split('\n'); let out=[]; let inCode=false; let codeBuf=[];
    for(let l of lines){
      if(l.trim().startsWith('```')){ if(!inCode){ inCode=true; codeBuf=[]; } else { inCode=false; out.push('<pre class="code-block"><code>'+escapeHtml(codeBuf.join('\n'))+'</code></pre>'); } continue; }
      if(inCode){ codeBuf.push(l); continue; }
      if(/^#{3}\s+/.test(l)){ out.push('<h3>'+escapeHtml(l.replace(/^#{3}\s+/,''))+'</h3>'); continue; }
      if(/^#{2}\s+/.test(l)){ out.push('<h2>'+escapeHtml(l.replace(/^#{2}\s+/,''))+'</h2>'); continue; }
      if(/^#{1}\s+/.test(l)){ out.push('<h1>'+escapeHtml(l.replace(/^#{1}\s+/,''))+'</h1>'); continue; }
      if(l.trim()===''){ out.push('<p></p>'); continue; }
      let t = escapeHtml(l).replace(/`([^`]+)`/g, (m,m1)=>'<code>'+m1+'</code>').replace(/\*\*([^*]+)\*\*/g,(m,m1)=>'<strong>'+m1+'</strong>').replace(/\*([^*]+)\*/g,(m,m1)=>'<em>'+m1+'</em>');
      out.push('<p>'+t+'</p>');
    }
    return out.join('');
  }
  function buildToc(md){
    const lines = md.split('\n'); const toc=[];
    for(const l of lines){ const m = l.match(/^(#{1,3})\s+(.*)$/); if(m) toc.push({ level:m[1].length, text:m[2].trim() }); }
    return toc;
  }
  function renderNotesForCurrentNotebook(){
    const md = notesInput.value || ''; notesRender.innerHTML = simpleMarkdownRender(md);
    const toc = buildToc(md); tocList.innerHTML='';
    toc.forEach((item, idx)=>{ const div=document.createElement('div'); div.className='toc-item toc-h'+item.level; div.textContent=item.text; div.addEventListener('click', ()=>{
        const lines = notesInput.value.split('\n'); for(let i=0;i<lines.length;i++){ if(lines[i].replace(/^#{1,3}\s+/,'').trim() === item.text){ let idxChar=0; for(let k=0;k<i;k++) idxChar += lines[k].length + 1; notesInput.focus(); notesInput.setSelectionRange(idxChar, idxChar + lines[i].length); const headers = notesRender.querySelectorAll('h1,h2,h3'); if(headers[idx]) headers[idx].scrollIntoView({behavior:'smooth',block:'center'}); break; } }
      }); tocList.appendChild(div); });
    if(!currentNotebookId) return;
    const nb = notebooks.find(x=>x.id===currentNotebookId); if(!nb) return;
    nb.content = md; nb.updatedAt = Date.now(); saveNotebooks();
  }

  btnInsertH1.addEventListener('click', ()=>{ insertAtCursor(notesInput, '# 新标题\n'); renderNotesForCurrentNotebook(); });
  btnInsertH2.addEventListener('click', ()=>{ insertAtCursor(notesInput, '## 新子标题\n'); renderNotesForCurrentNotebook(); });
  btnInsertH3.addEventListener('click', ()=>{ insertAtCursor(notesInput, '### 新小标题\n'); renderNotesForCurrentNotebook(); });
  btnClearNotes.addEventListener('click', ()=>{ if(confirm('清空笔记将无法恢复，是否继续？')){ notesInput.value=''; renderNotesForCurrentNotebook(); }});
  function insertAtCursor(textarea, text){ const start = textarea.selectionStart || 0; const end = textarea.selectionEnd || 0; const v = textarea.value; textarea.value = v.slice(0,start) + text + v.slice(end); textarea.selectionStart = textarea.selectionEnd = start + text.length; textarea.focus(); }

  // Support Tab / Shift+Tab indentation in notesInput
  notesInput.addEventListener('keydown',(e)=>{
    if(e.key==='Tab'){
      e.preventDefault();
      const el = notesInput; const start = el.selectionStart, end = el.selectionEnd;
      // If selection spans multiple lines -> indent all lines
      const value = el.value; const before = value.slice(0,start); const selection = value.slice(start,end); const after = value.slice(end);
      if(!e.shiftKey){
        // indent selection or insert tab
        if(selection.includes('\n')){
          const lines = selection.split('\n'); for(let i=0;i<lines.length;i++) lines[i] = '\t'+lines[i]; const newSel = lines.join('\n');
          el.value = before + newSel + after; el.selectionStart = start; el.selectionEnd = start + newSel.length;
        } else {
          el.value = before + '\t' + selection + after; el.selectionStart = el.selectionEnd = start + 1;
        }
      } else {
        // unindent: remove leading tab or 4 spaces
        if(selection.includes('\n')){
          const lines = selection.split('\n'); for(let i=0;i<lines.length;i++){ if(lines[i].startsWith('\t')) lines[i]=lines[i].slice(1); else if(lines[i].startsWith('    ')) lines[i]=lines[i].slice(4); }
          const newSel = lines.join('\n'); el.value = before + newSel + after; el.selectionStart=start; el.selectionEnd=start + newSel.length;
        } else {
          const selLineStart = value.lastIndexOf('\n', start-1) + 1; const selLine = value.slice(selLineStart, end);
          if(selLine.startsWith('\t')){ el.value = value.slice(0, selLineStart) + selLine.slice(1) + value.slice(end); el.selectionStart = el.selectionEnd = start - 1; }
        }
      }
      if(currentNotebookId) { if(notesTimer) clearTimeout(notesTimer); notesTimer = setTimeout(()=>{ renderNotesForCurrentNotebook(); notesTimer=null; }, 200); }
    }
  });

  notesInput.addEventListener('input', ()=>{
    if(currentNotebookId){ if(notesTimer) clearTimeout(notesTimer); notesTimer = setTimeout(()=>{ renderNotesForCurrentNotebook(); notesTimer=null; }, 200); }
  });

  // Helper render notes list view
  function renderNotesListView(){ notebooksListWrap.style.display='block'; notebookEditorWrap.style.display='none'; renderNotebooksGrid(); }

  // Initialization
  function ensureNotebooksInitialized(){ if(!Array.isArray(notebooks)) notebooks=[]; renderNotebooksGrid(); }
  ensureNotebooksInitialized();

  // Calendar & init functions
  function initAll(){
    loadData(); renderProblemTable(); renderResources(); populateTagsDatalist(); renderNotesListView(); updateCalendar(); updateAddToNbOptions();
  }
  initAll();

  // Update calendar after load
  updateCalendar();
  updateAddToNbOptions();

  // Notes auto-save throttle exists as notesTimer
  // Keyboard shortcut Ctrl/Cmd+S export
  window.addEventListener('keydown',(e)=>{ if((e.ctrlKey||e.metaKey) && e.key.toLowerCase()==='s'){ e.preventDefault(); document.getElementById('btnExport').click(); } });

  // Add some minor functions used earlier
  function updateCalendar(){ /* regenerate calendar UI */ 
    calGridDays.innerHTML=''; const year=calDate.getFullYear(), month=calDate.getMonth(); calMonthLabel.textContent = `${year} 年 ${month+1} 月`; const firstDay=new Date(year,month,1); const startWeek = firstDay.getDay(); const daysInMonth = new Date(year, month+1,0).getDate();
    for(let i=0;i<startWeek;i++){ const div=document.createElement('div'); div.className='cal-day'; div.style.background='transparent'; div.style.border='none'; calGridDays.appendChild(div); }
    const map={}; for(const p of problems) if(p.date) (map[p.date]=map[p.date]||[]).push(p);
    const todayStr = formatYYYYMMDD(new Date());
    for(let d=1; d<=daysInMonth; d++){ const dt=new Date(year,month,d); const iso=formatYYYYMMDD(dt); const div=document.createElement('div'); div.className='cal-day'+(iso===todayStr?' today':''); div.dataset.date=iso; div.innerHTML=`<div class="date-num">${d}</div>`;
      if(map[iso] && map[iso].length){ const dotsWrap=document.createElement('div'); dotsWrap.style.position='absolute'; dotsWrap.style.right='6px'; dotsWrap.style.bottom='6px'; for(let i=0;i<Math.min(3,map[iso].length);i++){ const dot=document.createElement('span'); dot.className='dot'; dot.title=map[iso][i].title; dot.style.background = i===0? 'var(--accent)' : (i===1? 'var(--primary)' : '#f39c12'); dotsWrap.appendChild(dot); } div.appendChild(dotsWrap); }
      div.addEventListener('click', ()=>onCalendarDateClick(iso)); calGridDays.appendChild(div);
    }
  }

  // Final helper: openNotebook, closeNotebook, renderNotesForCurrentNotebook already defined earlier.

</script>
</body>
</html>
