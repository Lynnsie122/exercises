<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="utf-8" />
  <title>åˆ·é¢˜è®°å½•æœ¬ - ç®—æ³•ï¼ˆæœ¬åœ°ä¿å­˜ï¼‰</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root{
      --primary:#1abc9c;
      --primary-dark:#16a085;
      --accent:#3498db;
      --bg:#f5f7fb;
      --card-bg:#ffffff;
      --text-main:#23303a;
      --text-sub:#60707a;
      --border:#e6eef2;
      --radius:12px;
      --shadow:0 12px 30px rgba(15,35,52,0.06);
      --base-font:16px;
    }
    *{box-sizing:border-box;margin:0;padding:0}
    body{
      font-family: Inter, "Segoe UI", Roboto, "PingFang SC", "Microsoft YaHei", Arial, sans-serif;
      background: linear-gradient(180deg,#f7fbfc 0%,#ffffff 100%);
      color:var(--text-main);
      font-size:var(--base-font);
      line-height:1.5;
      padding-bottom:40px;
    }
    header{position:sticky;top:0;background:rgba(255,255,255,0.95);backdrop-filter: blur(6px);border-bottom:1px solid rgba(230,238,242,0.9);z-index:50}
    .nav{max-width:1200px;margin:0 auto;display:flex;align-items:center;justify-content:space-between;padding:14px 18px}
    .brand{display:flex;gap:12px;align-items:center}
    .brand-logo{width:44px;height:44px;border-radius:10px;background:linear-gradient(135deg,var(--primary),var(--accent));display:flex;align-items:center;justify-content:center;color:#fff;font-weight:800;font-size:18px}
    .nav-links{display:flex;gap:8px;align-items:center}
    .nav-btn{background:transparent;border:none;padding:8px 12px;border-radius:999px;color:var(--text-sub);cursor:pointer;font-weight:600}
    .nav-btn.active{background:#fff;color:var(--primary-dark);box-shadow:0 6px 18px rgba(22,160,133,0.12);border:1px solid rgba(26,188,156,0.08)}
    main{max-width:1200px;margin:24px auto;padding:0 18px}
    .card{background:var(--card-bg);border-radius:18px;padding:22px;box-shadow:var(--shadow);border:1px solid rgba(255,255,255,0.9)}
    .section{display:none}
    .section.active{display:block}
    .section-header{display:flex;align-items:flex-start;justify-content:space-between;gap:12px;margin-bottom:14px;flex-wrap:wrap}
    .section-title{font-size:20px;font-weight:800}
    .home-grid{display:grid;grid-template-columns:2fr 1fr;gap:18px}
    .hero-title{font-size:28px;font-weight:800;margin-bottom:10px}
    .hero-desc{color:var(--text-sub);font-size:15px;margin-bottom:12px}
    .btn-primary{background:linear-gradient(135deg,var(--primary),var(--primary-dark));color:#fff;border:none;padding:10px 18px;border-radius:999px;font-weight:700;cursor:pointer}
    .tiny-btn{padding:6px 9px;border-radius:8px;border:1px solid rgba(35,48,58,0.06);background:#fff;cursor:pointer;font-size:13px}
    input[type=text], select, textarea, input[type=date]{
      width:100%;padding:10px 12px;border-radius:10px;border:1px solid var(--border);background:#fbfdff;font-size:15px;outline:none;
    }
    textarea{min-height:120px;resize:vertical}
    .list{margin-top:12px}
    .list-item{display:flex;justify-content:space-between;align-items:flex-start;padding:12px;border-radius:10px;background:rgba(255,255,255,0.98);border:1px solid rgba(230,238,242,0.9);margin-bottom:10px;gap:12px}
    .calendar-grid{display:grid;grid-template-columns:repeat(7,1fr);gap:6px;margin-top:8px}
    .calendar-day{height:72px;border-radius:10px;text-align:center;padding-top:8px;position:relative;border:1px solid transparent;background:#fff}
    .calendar-day.out-month{color:rgba(96,112,122,0.4);background:transparent;border:1px dashed rgba(230,238,242,0.7)}
    .calendar-day-number{font-weight:700;font-size:15px}
    .calendar-dot{width:10px;height:10px;border-radius:50%;margin:8px auto;background:var(--border)}
    .calendar-dot.active{background:linear-gradient(135deg,var(--primary),var(--accent));box-shadow:0 0 0 6px rgba(26,188,156,0.12)}
    .calendar-day.today{border:2px solid rgba(26,188,156,0.25);box-shadow:inset 0 0 0 4px rgba(26,188,156,0.03)}
    /* LeetCode-like view modal */
    .overlay{position:fixed;inset:0;background:rgba(10,20,30,0.45);display:flex;align-items:flex-start;justify-content:center;padding:40px;z-index:200}
    .editor-modal{width:1100px;max-width:96%;background:#fff;border-radius:12px;overflow:hidden;display:flex;box-shadow:0 18px 50px rgba(10,20,30,0.25)}
    .modal-left{flex:1;padding:20px;min-width:360px;border-right:1px solid rgba(230,238,242,0.9);max-height:80vh;overflow:auto}
    .modal-right{flex:1.2;padding:12px;display:flex;flex-direction:column;gap:8px;min-width:360px}
    .code-area{flex:1;border-radius:8px;border:1px solid rgba(230,238,242,0.9);background:#0f1720;color:#e6eef2;padding:12px;font-family:monospace;min-height:420px;overflow:auto}
    .code-toolbar{display:flex;gap:8px;align-items:center}
    .resource-list{margin-top:12px}
    .resource-item{display:flex;justify-content:space-between;align-items:center;padding:8px;border-radius:8px;border:1px solid rgba(230,238,242,0.9);background:#fff;margin-bottom:8px}
    @media (max-width:980px){ .home-grid{grid-template-columns:1fr} .modal-left{min-width:280px} }
  </style>
</head>
<body>
<header>
  <div class="nav">
    <div class="brand">
      <div class="brand-logo">Q</div>
      <div>
        <div class="brand-text-main">åˆ·é¢˜è®°å½•æœ¬ Â· ç®—æ³•</div>
        <div style="font-size:13px;color:var(--text-sub)">ç”µè„‘ç«¯ Â· æœ¬åœ°ä¿å­˜ï¼ˆlocalStorageï¼‰</div>
      </div>
    </div>
    <div class="nav-links">
      <button class="nav-btn active" data-target="home">ğŸ  é¦–é¡µ</button>
      <button class="nav-btn" data-target="add">â• æ·»åŠ é¢˜ç›®</button>
      <button class="nav-btn" data-target="category">ğŸ“‚ åˆ†ç±»</button>
      <button class="nav-btn" data-target="calendar">ğŸ“… æ—¥å†</button>
      <button class="nav-btn" data-target="notes">ğŸ“ å¿ƒå¾—</button>
      <button class="nav-btn" data-target="resource">ğŸ“š èµ„æº</button>
    </div>
  </div>
</header>

<main>
  <!-- HOME -->
  <section id="home" class="section active">
    <div class="card">
      <div class="section-header">
        <div>
          <div class="section-title">ç®—æ³•åˆ·é¢˜ Â· è®°å½•ä¸å¤ç›˜</div>
          <div style="color:var(--text-sub);margin-top:6px">é»˜è®¤åˆ†ç±»ï¼šç®—æ³•ï¼ˆåŠ¨æ€è§„åˆ’ã€å›¾è®ºã€è´ªå¿ƒç­‰ï¼‰ï¼Œæ•°æ®ä¿å­˜åœ¨æœ¬åœ°æµè§ˆå™¨ã€‚</div>
        </div>
        <div style="display:flex;flex-direction:column;gap:8px;align-items:flex-end">
          <div style="font-size:13px;color:var(--text-sub)">æœ¬åœ°æ•°æ®é”®ï¼š<code>algo_problems</code> / <code>algo_notes</code> / <code>algo_calendar</code> / <code>algo_resources</code></div>
          <div>
            <button class="btn-primary" onclick="switchSection('add')">æ–°å¢é¢˜ç›®</button>
            <button class="tiny-btn" onclick="switchSection('calendar')">æŸ¥çœ‹æ—¥å†</button>
          </div>
        </div>
      </div>

      <div class="home-grid">
        <div>
          <div class="hero-title">ä¿æŒèŠ‚å¥ Â· æ·±å…¥å¤ç›˜</div>
          <div class="hero-desc">æŠŠæ¯é“é¢˜çš„æ¥æºã€æ ¸å¿ƒæ€è·¯ã€æ˜“é”™ç‚¹å’Œä»£ç è®°å½•ä¸‹æ¥ï¼Œæ–¹ä¾¿æ—¥åå¤ç›˜ã€‚</div>

          <div class="card" style="margin-top:12px">
            <div style="display:flex;justify-content:space-between;align-items:center">
              <div style="font-weight:800">æœ€è¿‘é¢˜ç›®</div>
              <div style="color:var(--text-sub);font-size:13px" id="home-count">å…± 0 é“é¢˜</div>
            </div>
            <div id="home-list" class="list" style="margin-top:12px"></div>
          </div>
        </div>

        <div style="display:flex;flex-direction:column;gap:12px">
          <div class="card">
            <div style="font-weight:800">ç»Ÿè®¡</div>
            <div style="margin-top:10px;color:var(--text-sub)">
              æ€»é¢˜é‡ï¼š<span id="stat-total">0</span><br>
              DPï¼š<span id="stat-dp">0</span> Â· è´ªå¿ƒï¼š<span id="stat-greedy">0</span> Â· å›¾è®ºï¼š<span id="stat-graph">0</span> Â· æ•°æ®ç»“æ„ï¼š<span id="stat-ds">0</span>
            </div>
          </div>

          <div class="card">
            <div style="font-weight:800">å¿«é€Ÿæç¤º</div>
            <div style="margin-top:8px;color:var(--text-sub)">
              - æ¯é“é¢˜å¯åœ¨ä»£ç åŒºä¿å­˜ä½ çš„è§£æ³•ï¼ˆæ”¯æŒå¤šè¯­è¨€åˆ‡æ¢ï¼‰ã€‚<br>
              - æ·»åŠ é¢˜ç›®æ—¶å‹¾é€‰â€œä¸ºä»Šå¤©æ‰“å¡â€ä¼šæŠŠè¯¥é¢˜ä¸å½“æ—¥è®°å½•å…³è”ã€‚<br>
              - æ—¥å†ç‚¹å‡»æŸæ—¥ä¼šæ˜¾ç¤ºè¯¥æ—¥å…·ä½“é¢˜ç›®ã€‚
            </div>
          </div>
        </div>
      </div>
    </div>
  </section>

  <!-- ADD -->
  <section id="add" class="section">
    <div class="card">
      <div class="section-header">
        <div>
          <div class="section-title">æ·»åŠ æ–°çš„é¢˜ç›®</div>
          <div style="color:var(--text-sub)">ä»¿ LeetCodeï¼šè®°å½•æè¿°/æ€è·¯/é”™å› ï¼Œå¹¶èƒ½ä¿å­˜ä»£ç ã€‚</div>
        </div>
      </div>

      <div style="display:grid;grid-template-columns:1.6fr 1fr;gap:18px">
        <div>
          <label class="form-label">é¢˜ç›®åç§° / ç¼–å· <span style="color:#e74c3c">*</span></label>
          <input type="text" id="problem-title" placeholder="ä¾‹ï¼šLeetCode 53. æœ€å¤§å­æ•°ç»„å’Œ" />

          <div style="display:flex;gap:8px;margin-top:8px">
            <input type="text" id="problem-source" placeholder="æ¥æºï¼ˆLeetCode / é¢˜å•ï¼‰" />
            <select id="problem-level"><option value="">éš¾åº¦</option><option>ç®€å•</option><option>ä¸­ç­‰</option><option>å›°éš¾</option></select>
            <select id="problem-status"><option>å·²æŒæ¡</option><option>åšå¯¹ä½†ä¸ç†Ÿ</option><option>åšé”™ / æœªå®Œæˆ</option><option>å¾…å¤ä¹ </option></select>
          </div>

          <div style="margin-top:8px">
            <label class="form-label">æ ‡ç­¾ï¼ˆé€—å·åˆ†éš”ï¼‰</label>
            <input type="text" id="problem-tags" placeholder="ä¾‹å¦‚ï¼šåŠ¨æ€è§„åˆ’, åŒºé—´DP" />
            <div style="display:flex;gap:8px;margin-top:8px">
              <button class="tiny-btn" onclick="quickTag('problem-tags','åŠ¨æ€è§„åˆ’')">åŠ¨æ€è§„åˆ’</button>
              <button class="tiny-btn" onclick="quickTag('problem-tags','å›¾è®º')">å›¾è®º</button>
              <button class="tiny-btn" onclick="quickTag('problem-tags','è´ªå¿ƒ')">è´ªå¿ƒ</button>
              <button class="tiny-btn" onclick="quickTag('problem-tags','æ•°æ®ç»“æ„')">æ•°æ®ç»“æ„</button>
            </div>
          </div>

          <div style="margin-top:8px">
            <label class="form-label">é¢˜ç›®æè¿° / æç¤º</label>
            <textarea id="problem-desc" placeholder="æŠŠé¢˜ç›®æè¿°ç²˜è´´åœ¨è¿™é‡Œï¼ˆå¯å¤åˆ¶è‡ª LeetCodeï¼‰"></textarea>
          </div>

          <div style="margin-top:8px">
            <label class="form-label">è§£é¢˜æ€è·¯ï¼ˆè‡ªå·±çš„è¯ï¼‰ <span style="color:#e74c3c">*</span></label>
            <textarea id="problem-idea" placeholder="æ ¸å¿ƒæ€è·¯ã€å…³é”®çŠ¶æ€ã€å¤æ‚åº¦ç­‰"></textarea>
          </div>

          <div style="margin-top:8px">
            <label class="form-label">é”™è¯¯æ€»ç»“ / æ˜“é”™ç‚¹</label>
            <textarea id="problem-mistake" placeholder="é”™å› ã€è¾¹ç•Œã€éœ€è¦æ³¨æ„çš„ç‚¹"></textarea>
          </div>

          <div style="display:flex;align-items:center;gap:12px;margin-top:10px">
            <div><input type="checkbox" id="problem-check-calendar" /> <label for="problem-check-calendar" style="color:var(--text-sub)">åŒæ—¶ä¸ºä»Šå¤©æ‰“å¡ï¼ˆå¹¶å…³è”æœ¬é¢˜ï¼‰</label></div>
            <div style="margin-left:auto;color:var(--text-sub)">åˆ›å»ºæ—¶é—´ä¼šè‡ªåŠ¨è®°å½•å¹¶æ˜¾ç¤ºä¸º yyyy/mm/dd</div>
          </div>

          <div style="display:flex;justify-content:space-between;align-items:center;margin-top:12px">
            <div style="color:var(--text-sub)">å»ºè®®ï¼šåšå®Œé¢˜å°±è®°å½•ï¼Œä»£ç å†™åœ¨å³ä¾§å¹¶ä¿å­˜ã€‚</div>
            <div>
              <button class="tiny-btn" onclick="resetProblemForm()">æ¸…ç©º</button>
              <button class="btn-primary" onclick="saveProblem()">ä¿å­˜å¹¶å†™å…¥æœ¬åœ°</button>
            </div>
          </div>
        </div>

        <div>
          <div class="card">
            <div style="font-weight:700">ä»£ç ç¤ºä¾‹ï¼ˆä¿å­˜ä¸ºè¯¥é¢˜ä»£ç ï¼‰</div>
            <div style="margin-top:8px">
              <label style="font-size:13px;color:var(--text-sub)">è¯­è¨€</label>
              <select id="code-lang">
                <option>JavaScript</option>
                <option>Python</option>
                <option>Java</option>
                <option>C++</option>
              </select>
            </div>
            <div style="margin-top:8px">
              <textarea id="problem-code" class="code-area" placeholder="// åœ¨æ­¤å¤„å†™ä»£ç ï¼Œä¿å­˜åˆ°é¢˜ç›®ä¸­"></textarea>
            </div>
            <div style="display:flex;gap:8px;justify-content:flex-end;margin-top:8px">
              <button class="tiny-btn" onclick="loadSampleCode()">æ’å…¥ç¤ºä¾‹</button>
              <button class="tiny-btn" onclick="saveCodeToDraft()">ä¿å­˜ä»£ç åˆ°è‰ç¨¿ï¼ˆä»…æœ¬é¡µï¼‰</button>
            </div>
            <div style="margin-top:12px;color:var(--text-sub)">ä¿å­˜é¢˜ç›®æ—¶ï¼Œä»£ç ä¸è¯­è¨€ä¼šä¿å­˜åˆ°è¯¥é¢˜è®°å½•ä¸­ï¼ˆä»…æœ¬åœ°ï¼‰ã€‚</div>
          </div>

          <div style="margin-top:12px" class="card">
            <div style="font-weight:800">é¢„è§ˆ</div>
            <div style="margin-top:8px;color:var(--text-sub)">
              é¢˜ç›®åˆ›å»ºåå¯åœ¨ã€Œé¦–é¡µã€ä¸ã€Œåˆ†ç±»ã€ä¸­æŸ¥çœ‹ï¼Œä¸”å¯åœ¨æ—¥å†ä¸­æŸ¥çœ‹å½“å¤©å…³è”é¢˜ç›®å¹¶æ‰“å¼€æŸ¥çœ‹/ç¼–è¾‘ä»£ç ã€‚
            </div>
          </div>
        </div>
      </div>
    </div>
  </section>

  <!-- CATEGORY -->
  <section id="category" class="section">
    <div class="card">
      <div class="section-header">
        <div>
          <div class="section-title">é¢˜ç›®åˆ†ç±»</div>
          <div style="color:var(--text-sub)">æŒ‰æ ‡ç­¾ç­›é€‰é¢˜ç›®</div>
        </div>
      </div>
      <div id="category-list" class="list"></div>
    </div>
  </section>

  <!-- CALENDAR -->
  <section id="calendar" class="section">
    <div class="card">
      <div class="section-header">
        <div>
          <div class="section-title">æ—¥å† Â· åˆ·é¢˜æ‰“å¡</div>
          <div style="color:var(--text-sub)">ç‚¹å‡»æŸå¤©å¯åœ¨å³ä¾§çœ‹åˆ°è¯¥å¤©å…·ä½“åšäº†å“ªäº›é¢˜ï¼ˆæŒ‰æ·»åŠ æ—¶çš„å…³è”ï¼‰ã€‚</div>
        </div>
        <div>
          <button class="tiny-btn" onclick="prevMonth()">â€¹ ä¸Šæœˆ</button>
          <button class="tiny-btn" onclick="nextMonth()">ä¸‹æœˆ â€º</button>
          <button class="tiny-btn" onclick="goToday()">ä»Šå¤©</button>
        </div>
      </div>

      <div style="display:grid;grid-template-columns:2fr 1fr;gap:18px">
        <div>
          <div id="calendar-month" style="font-weight:800;margin-bottom:8px"></div>
          <div style="display:grid;grid-template-columns:repeat(7,1fr);gap:6px;font-weight:700;color:var(--text-sub);margin-bottom:6px">
            <div style="text-align:center">ä¸€</div><div style="text-align:center">äºŒ</div><div style="text-align:center">ä¸‰</div><div style="text-align:center">å››</div><div style="text-align:center">äº”</div><div style="text-align:center">å…­</div><div style="text-align:center">æ—¥</div>
          </div>
          <div id="calendar-grid" class="calendar-grid"></div>
        </div>

        <div>
          <div class="card" style="margin-bottom:12px">
            <div style="font-weight:800">é€‰ä¸­æ—¥æœŸè®°å½•</div>
            <div id="calendar-info" style="margin-top:8px;color:var(--text-sub)">è¯·é€‰æ‹©æŸä¸€å¤©æŸ¥çœ‹è¯¦æƒ…</div>
          </div>

          <div class="card">
            <div style="font-weight:800">è¿‘æœŸæ‰“å¡</div>
            <div id="calendar-log" style="margin-top:10px;color:var(--text-sub)"></div>
            <div style="margin-top:10px">
              <button class="tiny-btn" onclick="clearCalendar()">æ¸…é™¤å…¨éƒ¨æ—¥å†æ‰“å¡</button>
            </div>
          </div>
        </div>
      </div>
    </div>
  </section>

  <!-- NOTES -->
  <section id="notes" class="section">
    <div class="card">
      <div class="section-header">
        <div>
          <div class="section-title">å¿ƒå¾—æ„Ÿæ‚Ÿ</div>
          <div style="color:var(--text-sub)">è®°å½•å­¦ä¹ ç¬”è®°ã€æ¯æ—¥æ€»ç»“æˆ–å¤ç›˜è¦ç‚¹ï¼Œä¿å­˜åœ¨æœ¬åœ°ã€‚</div>
        </div>
      </div>

      <div style="display:grid;grid-template-columns:1.6fr 1fr;gap:18px">
        <div>
          <input type="text" id="note-title" placeholder="æ ‡é¢˜ï¼ˆå¯é€‰ï¼‰" />
          <div style="display:flex;gap:8px;margin-top:8px">
            <input type="date" id="note-date" />
            <input type="text" id="note-related" placeholder="å…³è”é¢˜ç›®ï¼ˆå¯å†™æ ‡é¢˜/ç¼–å·ï¼‰" />
          </div>
          <div style="margin-top:8px">
            <textarea id="note-content" placeholder="å†™ä¸‹ä½ çš„æƒ³æ³•ã€é”™å› åˆ†æã€æ”¹è¿›è®¡åˆ’"></textarea>
          </div>
          <div style="display:flex;justify-content:flex-end;gap:8px;margin-top:8px">
            <button class="tiny-btn" onclick="resetNoteForm()">æ¸…ç©º</button>
            <button class="btn-primary" onclick="saveNote()">ä¿å­˜å¿ƒå¾—</button>
          </div>
        </div>

        <div>
          <div style="font-weight:800;margin-bottom:8px">å†å²ç¬”è®°</div>
          <div id="note-history" style="max-height:420px;overflow:auto"></div>
          <div style="margin-top:10px;display:flex;gap:8px">
            <button class="tiny-btn" onclick="exportData()">å¯¼å‡ºæ•°æ®</button>
            <button class="tiny-btn" onclick="importData()">å¯¼å…¥æ•°æ®ï¼ˆè¦†ç›–ï¼‰</button>
            <button class="tiny-btn" onclick="clearAllData()" style="color:#b33">æ¸…ç©ºæ‰€æœ‰æœ¬åœ°æ•°æ®</button>
          </div>
        </div>
      </div>
    </div>
  </section>

  <!-- RESOURCE -->
  <section id="resource" class="section">
    <div class="card">
      <div class="section-header">
        <div>
          <div class="section-title">èµ„æº Â· è‡ªå®šä¹‰æ·»åŠ </div>
          <div style="color:var(--text-sub)">ä½ å¯ä»¥æ·»åŠ /åˆ é™¤/æ‰“å¼€è‡ªå·±çš„åˆ·é¢˜èµ„æºï¼ˆæœ¬åœ°ä¿å­˜ï¼‰ã€‚</div>
        </div>
      </div>

      <div style="display:flex;gap:12px">
        <div style="flex:1">
          <input type="text" id="resource-title" placeholder="èµ„æºåç§°ï¼ˆä¾‹å¦‚ï¼šLeetCode é¢˜å•ï¼‰" />
          <input type="text" id="resource-url" placeholder="é“¾æ¥ï¼ˆhttps://...ï¼‰" style="margin-top:8px" />
          <div style="display:flex;gap:8px;margin-top:8px">
            <button class="tiny-btn" onclick="addResource()">æ·»åŠ èµ„æº</button>
            <button class="tiny-btn" onclick="clearResourceForm()">æ¸…ç©º</button>
          </div>
        </div>
        <div style="flex:1">
          <div style="font-weight:800">èµ„æºåˆ—è¡¨</div>
          <div id="resource-list" class="resource-list"></div>
        </div>
      </div>
    </div>
  </section>
</main>

<!-- ç¼–è¾‘/æŸ¥çœ‹é¢˜ç›®æ¨¡æ€ï¼ˆæ¨¡æ‹Ÿ LeetCode é¢˜ç›®é¡µï¼šå·¦ä¾§é¢˜ç›®ï¼Œå³ä¾§ä»£ç ï¼‰ -->
<div id="problem-modal-root" style="display:none"></div>

<script>
  // ---------- helpers ----------
  const STORAGE_KEYS = {
    problems: 'algo_problems',
    notes: 'algo_notes',
    calendar: 'algo_calendar', // map date -> array of problem ids (['p_...'])
    resources: 'algo_resources'
  };

  function saveJSON(k,v){ localStorage.setItem(k, JSON.stringify(v)); }
  function loadJSON(k, def){ try{ const r=localStorage.getItem(k); return r?JSON.parse(r):def; }catch(e){return def;} }
  function ensureStorage(){ if(!localStorage.getItem(STORAGE_KEYS.problems)) saveJSON(STORAGE_KEYS.problems, []); if(!localStorage.getItem(STORAGE_KEYS.notes)) saveJSON(STORAGE_KEYS.notes, []); if(!localStorage.getItem(STORAGE_KEYS.calendar)) saveJSON(STORAGE_KEYS.calendar, {}); if(!localStorage.getItem(STORAGE_KEYS.resources)) saveJSON(STORAGE_KEYS.resources, []); }
  ensureStorage();

  // æ—¥æœŸæ ¼å¼åŒ–ä¸º yyyy/mm/ddï¼ˆå¸¦æ–œæ ï¼‰
  function ymdSlash(y,m,d){ const mm=String(m).padStart(2,'0'), dd=String(d).padStart(2,'0'); return `${y}/${mm}/${dd}`; }
  function todayString(){ const t=new Date(); return ymdSlash(t.getFullYear(), t.getMonth()+1, t.getDate()); }
  function isoToSlash(iso){ if(!iso) return ''; const d=new Date(iso); return ymdSlash(d.getFullYear(), d.getMonth()+1, d.getDate()); }
  function formatDateToLocale(iso){ if(!iso) return ''; const d=new Date(iso); return d.toLocaleString(); }

  // ---------- å¯¼èˆª ----------
  const navButtons = document.querySelectorAll('.nav-btn');
  const sections = document.querySelectorAll('.section');
  function switchSection(id){
    sections.forEach(s=>s.id===id? s.classList.add('active'): s.classList.remove('active'));
    navButtons.forEach(b=>b.dataset.target===id? b.classList.add('active'): b.classList.remove('active'));
    window.scrollTo({top:0,behavior:'smooth'});
    if(id==='home') renderHomeList();
    if(id==='calendar') renderCalendar(currentDate);
    if(id==='notes') renderNotes();
    if(id==='resource') renderResourceList();
    if(id==='category') renderCategoryList();
  }
  navButtons.forEach(b=>b.addEventListener('click', ()=> switchSection(b.dataset.target)));

  // ---------- Problem add/edit ----------
  function resetProblemForm(){
    document.getElementById('problem-title').value='';
    document.getElementById('problem-source').value='';
    document.getElementById('problem-level').value='';
    document.getElementById('problem-status').value='å·²æŒæ¡';
    document.getElementById('problem-tags').value='';
    document.getElementById('problem-desc').value='';
    document.getElementById('problem-idea').value='';
    document.getElementById('problem-mistake').value='';
    document.getElementById('problem-code').value='';
    document.getElementById('code-lang').value='JavaScript';
    document.getElementById('problem-check-calendar').checked=false;
  }

  function quickTag(id,tag){
    const input = document.getElementById(id);
    const cur = input.value.trim();
    const arr = cur? cur.split(',').map(s=>s.trim()).filter(Boolean):[];
    if(!arr.includes(tag)) arr.push(tag);
    input.value = arr.join(', ');
  }

  function saveProblem(){
    const title = document.getElementById('problem-title').value.trim();
    if(!title){ alert('è¯·å¡«å†™é¢˜ç›®åç§°/ç¼–å·'); return; }
    const code = document.getElementById('problem-code').value;
    const lang = document.getElementById('code-lang').value;
    const p = {
      id: 'p_' + Date.now(),
      title,
      source: document.getElementById('problem-source').value.trim(),
      level: document.getElementById('problem-level').value,
      status: document.getElementById('problem-status').value,
      tags: document.getElementById('problem-tags').value.split(',').map(s=>s.trim()).filter(Boolean),
      desc: document.getElementById('problem-desc').value.trim(),
      idea: document.getElementById('problem-idea').value.trim(),
      mistake: document.getElementById('problem-mistake').value.trim(),
      code: code || '',
      codeLang: lang || 'JavaScript',
      createdAt: new Date().toISOString()
    };
    const list = loadJSON(STORAGE_KEYS.problems, []);
    list.unshift(p);
    saveJSON(STORAGE_KEYS.problems, list);

    // å¦‚æœå‹¾é€‰ä¸ºä»Šå¤©æ‰“å¡ -> åœ¨ calendar ä¸­æŠŠè¿™ä¸ªé—®é¢˜ id å…³è”åˆ°ä»Šå¤©
    if(document.getElementById('problem-check-calendar').checked){
      const key = todayString();
      const cal = loadJSON(STORAGE_KEYS.calendar, {});
      // å…¼å®¹è€æ ¼å¼ï¼šå¦‚æœæ˜¯æ•°å­—åˆ™è½¬æˆæ•°ç»„
      if(typeof cal[key] === 'number') cal[key] = []; 
      cal[key] = cal[key] || [];
      cal[key].unshift(p.id);
      saveJSON(STORAGE_KEYS.calendar, cal);
    }

    resetProblemForm();
    renderHomeList();
    renderCalendar(currentDate);
    renderCategoryList();
    alert('é¢˜ç›®å·²ä¿å­˜åˆ°æœ¬åœ°ï¼ˆlocalStorageï¼‰ã€‚');
    switchSection('home');
  }

  // ---------- Home / list / view ----------
  function escapeHTML(s){ if(!s) return ''; return String(s).replace(/[&<>"']/g, m=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m])); }

  function renderHomeList(){
    const container = document.getElementById('home-list');
    container.innerHTML = '';
    const list = loadJSON(STORAGE_KEYS.problems, []);
    document.getElementById('home-count').innerText = `å…± ${list.length} é“é¢˜`;
    const slice = list.slice(0, 12);
    slice.forEach(p=>{
      const div = document.createElement('div'); div.className='list-item';
      const tagText = p.tags && p.tags.length? p.tags.join('ï¼Œ') : 'â€”';
      div.innerHTML = `
        <div style="flex:1">
          <div style="font-weight:700">${escapeHTML(p.title)}</div>
          <div style="color:var(--text-sub);margin-top:6px">${tagText} Â· ${p.level||'â€”'} Â· ${isoToSlash(p.createdAt)}</div>
          <div style="margin-top:8px;color:var(--text-sub);white-space:pre-wrap">${escapeHTML((p.idea||'').slice(0,220))}${(p.idea||'').length>220?'...':''}</div>
        </div>
        <div style="display:flex;flex-direction:column;gap:8px;align-items:flex-end">
          <button class="tiny-btn" onclick="openProblemModal('${p.id}')">æŸ¥çœ‹ / ç¼–è¾‘</button>
          <button class="tiny-btn" onclick="deleteProblem('${p.id}')">åˆ é™¤</button>
        </div>
      `;
      container.appendChild(div);
    });
    renderStats();
  }

  function deleteProblem(id){
    if(!confirm('ç¡®è®¤åˆ é™¤è¯¥é¢˜ç›®ï¼Ÿæ­¤æ“ä½œä¸å¯æ¢å¤ã€‚')) return;
    let list = loadJSON(STORAGE_KEYS.problems, []);
    list = list.filter(x=>x.id!==id);
    saveJSON(STORAGE_KEYS.problems, list);
    // åŒæ—¶ä» calendar ä¸­ç§»é™¤
    const cal = loadJSON(STORAGE_KEYS.calendar, {});
    Object.keys(cal).forEach(k=>{
      if(Array.isArray(cal[k])) cal[k] = cal[k].filter(pid=>pid!==id);
      // æ¸…ç©ºç©ºæ•°ç»„
      if(Array.isArray(cal[k]) && cal[k].length===0) delete cal[k];
    });
    saveJSON(STORAGE_KEYS.calendar, cal);
    renderHomeList(); renderCalendar(currentDate); renderNotes(); renderCategoryList();
  }

  function renderStats(){
    const list = loadJSON(STORAGE_KEYS.problems, []);
    document.getElementById('stat-total').innerText = list.length;
    const tagCounts = { 'åŠ¨æ€è§„åˆ’':0, 'è´ªå¿ƒ':0, 'å›¾è®º':0, 'æ•°æ®ç»“æ„':0 };
    list.forEach(p=>{ (p.tags||[]).forEach(t=>{ if(tagCounts[t]!==undefined) tagCounts[t]++; }); });
    document.getElementById('stat-dp').innerText = tagCounts['åŠ¨æ€è§„åˆ’'] || 0;
    document.getElementById('stat-greedy').innerText = tagCounts['è´ªå¿ƒ'] || 0;
    document.getElementById('stat-graph').innerText = tagCounts['å›¾è®º'] || 0;
    document.getElementById('stat-ds').innerText = tagCounts['æ•°æ®ç»“æ„'] || 0;
  }

  // ---------- Category (æŒ‰æ ‡ç­¾) ----------
  function renderCategoryList(){
    const container = document.getElementById('category-list');
    container.innerHTML = '';
    const list = loadJSON(STORAGE_KEYS.problems, []);
    // æ”¶é›†æ ‡ç­¾
    const tags = {};
    list.forEach(p=> (p.tags||[]).forEach(t=> tags[t]= (tags[t]||0) + 1 ));
    const arr = Object.keys(tags).sort((a,b)=>tags[b]-tags[a]);
    if(arr.length===0){ container.innerHTML = '<div style="color:var(--text-sub)">æš‚æ— æ ‡ç­¾</div>'; return; }
    arr.forEach(t=>{
      const div = document.createElement('div'); div.className='list-item';
      div.innerHTML = `
        <div style="flex:1">
          <div style="font-weight:700">${escapeHTML(t)}</div>
          <div style="color:var(--text-sub);margin-top:6px">${tags[t]} é“é¢˜</div>
        </div>
        <div style="display:flex;align-items:center">
          <button class="tiny-btn" onclick="filterByTag('${t}')">æŸ¥çœ‹</button>
        </div>
      `;
      container.appendChild(div);
    });
  }

  function filterByTag(tag){
    const list = loadJSON(STORAGE_KEYS.problems, []);
    const filtered = list.filter(p=> (p.tags||[]).includes(tag) );
    if(filtered.length===0){ alert('å½“å‰æ²¡æœ‰è¯¥æ ‡ç­¾çš„é¢˜ç›®'); return; }
    // å¼¹çª—æ˜¾ç¤ºåˆ—è¡¨
    let html = `<div style="padding:18px;font-family:system-ui"><h2>æ ‡ç­¾ï¼š${escapeHTML(tag)}</h2>`;
    filtered.forEach(p=> html += `<div style="margin-top:12px"><div style="font-weight:700">${escapeHTML(p.title)}</div><div style="color:#666;margin-top:6px">${escapeHTML((p.idea||'').slice(0,180))}</div><div style="margin-top:6px"><button onclick="window.opener && window.opener.openProblemModal('${p.id}')" class="tiny-btn">æ‰“å¼€</button></div></div>`);
    html += '</div>';
    const w = window.open('','_blank','width=800,height=600'); w.document.write(html); w.document.title = 'æ ‡ç­¾ï¼š' + tag;
  }

  // ---------- Calendar ----------
  let currentDate = new Date();
  const calendarGrid = document.getElementById('calendar-grid');
  const calendarMonthLabel = document.getElementById('calendar-month');

  function renderCalendar(date){
    const year = date.getFullYear(), month = date.getMonth();
    calendarMonthLabel.innerText = `${year} å¹´ ${month+1} æœˆ`;
    calendarGrid.innerHTML = '';
    // leading days
    const firstDay = new Date(year, month, 1);
    const lastDay = new Date(year, month+1, 0);
    const firstWeekday = (firstDay.getDay()+6)%7; // 0=Mon
    const leading = firstWeekday;
    const prevMonthLastDate = new Date(year, month, 0).getDate();
    for(let i=0;i<leading;i++){
      const dayNum = prevMonthLastDate - leading + 1 + i;
      const cell = createDayCell(dayNum, false);
      calendarGrid.appendChild(cell);
    }
    // days
    const daysInMonth = lastDay.getDate();
    const cal = loadJSON(STORAGE_KEYS.calendar, {});
    const today = new Date();
    for(let d=1; d<=daysInMonth; d++){
      const isToday = (year===today.getFullYear() && month===today.getMonth() && d===today.getDate());
      const key = ymdSlash(year, month+1, d);
      let count = 0;
      if(cal[key]){
        if(Array.isArray(cal[key])) count = cal[key].length;
        else if(typeof cal[key] === 'number') count = cal[key];
      }
      const cell = createDayCell(d, true, count, isToday, key);
      calendarGrid.appendChild(cell);
    }
    // trailing to keep 6 rows
    const totalCells = leading + daysInMonth;
    const minTotal = 7 * 6;
    const trailing = (minTotal - totalCells) > 0 ? (minTotal - totalCells) : 0;
    for(let i=1;i<=trailing;i++){
      calendarGrid.appendChild(createDayCell(i,false));
    }
    renderCalendarLog();
  }

  function createDayCell(dayNum, inMonth, count=0, isToday=false, key){
    const cell = document.createElement('div'); cell.className='calendar-day';
    if(!inMonth) cell.classList.add('out-month'); else cell.classList.add('in-month');
    if(isToday) cell.classList.add('today');
    const num = document.createElement('div'); num.className='calendar-day-number'; num.innerText = dayNum; cell.appendChild(num);
    const dot = document.createElement('div'); dot.className='calendar-dot'; if(count>0 && inMonth) dot.classList.add('active'); cell.appendChild(dot);
    if(inMonth){
      cell.style.cursor='pointer';
      cell.addEventListener('click', ()=> selectCalendarDay(key));
    }
    return cell;
  }

  function prevMonth(){ currentDate.setMonth(currentDate.getMonth()-1); renderCalendar(currentDate); }
  function nextMonth(){ currentDate.setMonth(currentDate.getMonth()+1); renderCalendar(currentDate); }
  function goToday(){ currentDate = new Date(); renderCalendar(currentDate); }

  function selectCalendarDay(key){
    const cal = loadJSON(STORAGE_KEYS.calendar, {});
    const arr = cal[key] || [];
    const info = document.getElementById('calendar-info');
    if(!arr || arr.length===0){
      info.innerHTML = `<div style="font-weight:800">${key}</div><div style="margin-top:8px;color:var(--text-sub)">å½“æ—¥æ— å…³è”é¢˜ç›®</div><div style="margin-top:8px"><button class="tiny-btn" onclick="toggleCalendar('${key}')">æ ‡è®°ä¸ºå·²æ‰“å¡</button></div>`;
      return;
    }
    // æ˜¾ç¤ºè¯¥æ—¥åšçš„å…·ä½“é¢˜ç›®ï¼ˆé€šè¿‡ id å…³è”ï¼‰
    const problems = loadJSON(STORAGE_KEYS.problems, []);
    let html = `<div style="font-weight:800">${key}</div><div style="margin-top:8px;color:var(--text-sub)">å…± ${arr.length} é“é¢˜</div><div style="margin-top:8px">`;
    arr.forEach(pid=>{
      const p = problems.find(x=>x.id===pid);
      if(p){
        html += `<div style="display:flex;justify-content:space-between;align-items:center;padding:8px;border-radius:8px;margin-bottom:6px;background:#fbfdff;border:1px solid rgba(230,238,242,0.9)"><div><div style="font-weight:700">${escapeHTML(p.title)}</div><div style="color:var(--text-sub);font-size:13px">${(p.tags||[]).join('ï¼Œ') || 'â€”'} Â· ${p.level||'â€”'}</div></div><div><button class="tiny-btn" onclick="openProblemModal('${p.id}')">æ‰“å¼€</button></div></div>`;
      } else {
        html += `<div style="padding:8px;color:var(--text-sub)">å·²å…³è”é¢˜ç›®ï¼ˆIDï¼š${escapeHTML(pid)}ï¼‰ä½†æœ¬åœ°å·²åˆ é™¤</div>`;
      }
    });
    html += `</div><div style="margin-top:8px"><button class="tiny-btn" onclick="clearDay('${key}')">ç§»é™¤è¯¥æ—¥å…¨éƒ¨å…³è”</button></div>`;
    info.innerHTML = html;
  }

  function toggleCalendar(key){
    const cal = loadJSON(STORAGE_KEYS.calendar, {});
    if(!cal[key]) cal[key] = []; // æ ‡è®°ä¸ºç©ºæ•°ç»„è¡¨ç¤ºå·²æ‰“å¡ä½†æ— é¢˜ç›®
    saveJSON(STORAGE_KEYS.calendar, cal);
    renderCalendar(currentDate);
    document.getElementById('calendar-info').innerHTML = `<div style="color:var(--text-sub)">å·²æ›´æ–° ${key}</div>`;
  }

  function clearDay(key){
    if(!confirm('ç¡®è®¤ç§»é™¤è¯¥æ—¥æ‰€æœ‰å…³è”é¢˜ç›®ï¼Ÿ')) return;
    const cal = loadJSON(STORAGE_KEYS.calendar, {});
    delete cal[key];
    saveJSON(STORAGE_KEYS.calendar, cal);
    renderCalendar(currentDate);
    document.getElementById('calendar-info').innerHTML = `<div style="color:var(--text-sub)">${key} å·²æ¸…é™¤</div>`;
  }

  function clearCalendar(){
    if(!confirm('ç¡®è®¤æ¸…é™¤æ‰€æœ‰æ—¥å†æ‰“å¡ï¼Ÿæ­¤æ“ä½œä¸å¯é€†ã€‚')) return;
    saveJSON(STORAGE_KEYS.calendar, {});
    renderCalendar(currentDate);
  }

  function renderCalendarLog(){
    const log = document.getElementById('calendar-log');
    log.innerHTML = '';
    const cal = loadJSON(STORAGE_KEYS.calendar, {});
    const keys = Object.keys(cal).sort((a,b)=>b.localeCompare(a)).slice(0,8);
    if(keys.length===0){ log.innerText = 'æš‚æ— æ‰“å¡è®°å½•'; return; }
    keys.forEach(k=>{
      const val = cal[k];
      const count = Array.isArray(val)? val.length : (typeof val === 'number' ? val : 0);
      const div = document.createElement('div'); div.style.padding='6px 0'; div.style.borderBottom='1px dashed rgba(230,238,242,0.9)';
      div.innerHTML = `<div style="display:flex;justify-content:space-between"><div>${k}</div><div>${count} é¢˜</div></div>`;
      log.appendChild(div);
    });
  }

  // ---------- Notes ----------
  function resetNoteForm(){ document.getElementById('note-title').value=''; document.getElementById('note-date').value=''; document.getElementById('note-related').value=''; document.getElementById('note-content').value=''; }
  function saveNote(){
    const content = document.getElementById('note-content').value.trim(); if(!content){ alert('è¯·å¡«å†™å†…å®¹'); return; }
    const note = { id:'n_'+Date.now(), title:document.getElementById('note-title').value.trim(), date: document.getElementById('note-date').value || todayString(), related: document.getElementById('note-related').value.trim(), content, createdAt:new Date().toISOString() };
    const list = loadJSON(STORAGE_KEYS.notes, []); list.unshift(note); saveJSON(STORAGE_KEYS.notes, list); resetNoteForm(); renderNotes(); alert('ç¬”è®°å·²ä¿å­˜åˆ°æœ¬åœ°ã€‚'); switchSection('notes');
  }
  function renderNotes(){
    const container = document.getElementById('note-history'); container.innerHTML = '';
    const list = loadJSON(STORAGE_KEYS.notes, []);
    if(list.length===0){ container.innerHTML = '<div style="color:var(--text-sub)">æš‚æ— ç¬”è®°</div>'; return; }
    list.forEach(n=>{
      const div = document.createElement('div'); div.style.padding='8px'; div.style.borderBottom='1px dashed rgba(230,238,242,0.9)';
      div.innerHTML = `<div style="display:flex;justify-content:space-between;align-items:center"><div><div style="font-weight:700">${escapeHTML(n.title || (n.content.slice(0,30)))}</div><div style="color:var(--text-sub);font-size:13px">${n.date} Â· å…³è”ï¼š${escapeHTML(n.related||'â€”')}</div></div><div style="display:flex;gap:8px"><button class="tiny-btn" onclick="viewNote('${n.id}')">æŸ¥çœ‹</button><button class="tiny-btn" onclick="deleteNote('${n.id}')">åˆ é™¤</button></div></div><div style="margin-top:8px;color:var(--text-sub);white-space:pre-wrap">${escapeHTML(n.content.slice(0,200))}${n.content.length>200?'...':''}</div>`;
      container.appendChild(div);
    });
  }
  function viewNote(id){ const list = loadJSON(STORAGE_KEYS.notes, []); const n = list.find(x=>x.id===id); if(!n) return alert('æœªæ‰¾åˆ°è¯¥ç¬”è®°'); const w = window.open('','_blank','width=700,height=600'); w.document.write(`<div style="font-family:system-ui;padding:18px"><h2>${escapeHTML(n.title||'ç¬”è®°')}</h2><div style="color:#666;margin-top:8px">${n.date} Â· å…³è”ï¼š${escapeHTML(n.related||'â€”')}</div><div style="margin-top:12px;white-space:pre-wrap">${escapeHTML(n.content)}</div><div style="margin-top:12px;color:#888">åˆ›å»ºï¼š${formatDateToLocale(n.createdAt)}</div></div>`); }
  function deleteNote(id){ if(!confirm('åˆ é™¤è¯¥ç¬”è®°ï¼Ÿ')) return; let list = loadJSON(STORAGE_KEYS.notes, []); list = list.filter(x=>x.id!==id); saveJSON(STORAGE_KEYS.notes, list); renderNotes(); }

  // ---------- Resources (å¯è‡ªå®šä¹‰) ----------
  function clearResourceForm(){ document.getElementById('resource-title').value=''; document.getElementById('resource-url').value=''; }
  function addResource(){
    const title = document.getElementById('resource-title').value.trim();
    const url = document.getElementById('resource-url').value.trim();
    if(!title || !url){ alert('è¯·å¡«å†™åç§°ä¸é“¾æ¥'); return; }
    const res = { id:'r_'+Date.now(), title, url, createdAt:new Date().toISOString() };
    const list = loadJSON(STORAGE_KEYS.resources, []); list.unshift(res); saveJSON(STORAGE_KEYS.resources, list); clearResourceForm(); renderResourceList(); alert('å·²æ·»åŠ èµ„æº');
  }
  function renderResourceList(){
    const container = document.getElementById('resource-list'); container.innerHTML = '';
    const list = loadJSON(STORAGE_KEYS.resources, []);
    if(list.length===0){ container.innerHTML = '<div style="color:var(--text-sub)">æš‚æ— èµ„æº</div>'; return; }
    list.forEach(r=>{
      const div = document.createElement('div'); div.className='resource-item';
      div.innerHTML = `<div><div style="font-weight:700">${escapeHTML(r.title)}</div><div style="color:var(--text-sub);font-size:13px">${escapeHTML(isoToSlash(r.createdAt))}</div></div><div style="display:flex;gap:6px"><a class="tiny-btn" href="${escapeHTML(r.url)}" target="_blank">æ‰“å¼€</a><button class="tiny-btn" onclick="deleteResource('${r.id}')">åˆ é™¤</button></div>`;
      container.appendChild(div);
    });
  }
  function deleteResource(id){ if(!confirm('åˆ é™¤è¯¥èµ„æºï¼Ÿ')) return; let list = loadJSON(STORAGE_KEYS.resources, []); list = list.filter(x=>x.id!==id); saveJSON(STORAGE_KEYS.resources, list); renderResourceList(); }

  // ---------- å¯¼å‡º/å¯¼å…¥/æ¸…ç©º ----------
  function exportData(){
    const data = { problems: loadJSON(STORAGE_KEYS.problems, []), notes: loadJSON(STORAGE_KEYS.notes, []), calendar: loadJSON(STORAGE_KEYS.calendar, {}), resources: loadJSON(STORAGE_KEYS.resources, []) };
    const blob = new Blob([JSON.stringify(data, null, 2)], {type:'application/json'});
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a'); a.href=url; a.download = 'algo_data_export_'+new Date().toISOString().slice(0,19).replace(/[:T]/g,'_')+'.json'; document.body.appendChild(a); a.click(); a.remove(); URL.revokeObjectURL(url);
  }
  function importData(){
    const input = document.createElement('input'); input.type='file'; input.accept='application/json';
    input.onchange = e=>{
      const file = e.target.files[0]; if(!file) return;
      const reader = new FileReader();
      reader.onload = ev=>{
        try{
          const obj = JSON.parse(ev.target.result);
          if(confirm('å¯¼å…¥å°†è¦†ç›–ç°æœ‰æœ¬åœ°æ•°æ®ï¼Œç¡®å®šç»§ç»­ï¼Ÿ')){
            saveJSON(STORAGE_KEYS.problems, obj.problems || []);
            saveJSON(STORAGE_KEYS.notes, obj.notes || []);
            saveJSON(STORAGE_KEYS.calendar, obj.calendar || {});
            saveJSON(STORAGE_KEYS.resources, obj.resources || []);
            alert('å¯¼å…¥æˆåŠŸ');
            renderHomeList(); renderNotes(); renderCalendar(currentDate); renderResourceList(); renderCategoryList();
          }
        }catch(err){ alert('å¯¼å…¥æ–‡ä»¶æ— æ•ˆï¼š' + err.message); }
      }; reader.readAsText(file);
    };
    input.click();
  }
  function clearAllData(){ if(!confirm('ç¡®è®¤æ¸…ç©ºæ‰€æœ‰æœ¬åœ°æ•°æ®ï¼Ÿæ­¤æ“ä½œä¸å¯æ¢å¤ã€‚')) return; localStorage.removeItem(STORAGE_KEYS.problems); localStorage.removeItem(STORAGE_KEYS.notes); localStorage.removeItem(STORAGE_KEYS.calendar); localStorage.removeItem(STORAGE_KEYS.resources); ensureStorage(); renderHomeList(); renderNotes(); renderCalendar(currentDate); renderResourceList(); renderCategoryList(); }

  // ---------- Problem modal (LeetCode-like) ----------
  const modalRoot = document.getElementById('problem-modal-root');
  function openProblemModal(id){
    const problems = loadJSON(STORAGE_KEYS.problems, []);
    const p = problems.find(x=>x.id===id);
    if(!p) return alert('æœªæ‰¾åˆ°è¯¥é¢˜ç›®');
    renderProblemModal(p);
  }

  function renderProblemModal(p){
    modalRoot.innerHTML = '';
    modalRoot.style.display = 'block';
    const overlay = document.createElement('div'); overlay.className='overlay';
    const modal = document.createElement('div'); modal.className='editor-modal';
    // left: details
    const left = document.createElement('div'); left.className='modal-left';
    left.innerHTML = `<div style="display:flex;justify-content:space-between;align-items:center"><div><h2 style="margin:0">${escapeHTML(p.title)}</h2><div style="color:var(--text-sub);margin-top:6px">${escapeHTML((p.tags||[]).join('ï¼Œ'))} Â· ${p.level||'â€”'}</div></div><div><button class="tiny-btn" id="modal-save-meta">ä¿å­˜</button><button class="tiny-btn" id="modal-close">å…³é—­</button></div></div>
      <div style="margin-top:12px"><div style="font-weight:700">é¢˜ç›®æè¿°</div><div style="margin-top:6px;color:var(--text-sub);white-space:pre-wrap">${escapeHTML(p.desc||'ï¼ˆæ— æè¿°ï¼‰')}</div></div>
      <div style="margin-top:12px"><div style="font-weight:700">è§£é¢˜æ€è·¯</div><div style="margin-top:6px;white-space:pre-wrap">${escapeHTML(p.idea||'')}</div></div>
      <div style="margin-top:12px"><div style="font-weight:700">é”™è¯¯æ€»ç»“</div><div style="margin-top:6px;white-space:pre-wrap">${escapeHTML(p.mistake||'')}</div></div>
      <div style="margin-top:12px;color:var(--text-sub)">åˆ›å»ºï¼š${isoToSlash(p.createdAt)}</div>
    `;
    // right: code editor
    const right = document.createElement('div'); right.className='modal-right';
    right.innerHTML = `<div style="display:flex;justify-content:space-between;align-items:center"><div style="display:flex;gap:8px;align-items:center"><label style="font-size:13px;color:var(--text-sub)">è¯­è¨€</label><select id="modal-code-lang"><option>JavaScript</option><option>Python</option><option>Java</option><option>C++</option></select></div><div style="display:flex;gap:8px"><button class="tiny-btn" id="modal-run">è¿è¡Œï¼ˆæ¨¡æ‹Ÿï¼‰</button><button class="tiny-btn" id="modal-save-code">ä¿å­˜ä»£ç </button></div></div><textarea id="modal-code-area" class="code-area"></textarea><div id="modal-run-output" style="background:#081018;color:#8ff;padding:8px;border-radius:8px;display:none"></div>`;
    modal.appendChild(left); modal.appendChild(right); overlay.appendChild(modal); modalRoot.appendChild(overlay);

    // fill values
    document.getElementById('modal-code-area').value = p.code || '';
    document.getElementById('modal-code-lang').value = p.codeLang || 'JavaScript';

    // handlers
    document.getElementById('modal-close').addEventListener('click', ()=>{ modalRoot.style.display='none'; modalRoot.innerHTML=''; });
    document.getElementById('modal-save-code').addEventListener('click', ()=>{
      const code = document.getElementById('modal-code-area').value;
      const lang = document.getElementById('modal-code-lang').value;
      // persist to storage
      const probs = loadJSON(STORAGE_KEYS.problems, []);
      const idx = probs.findIndex(x=>x.id===p.id);
      if(idx>=0){ probs[idx].code = code; probs[idx].codeLang = lang; saveJSON(STORAGE_KEYS.problems, probs); alert('ä»£ç å·²ä¿å­˜åˆ°æœ¬åœ°'); renderHomeList(); }
    });
    document.getElementById('modal-save-meta').addEventListener('click', ()=>{
      // allow editing idea/mistake/desc via prompt (è½»é‡æ–¹å¼)
      const probs = loadJSON(STORAGE_KEYS.problems, []);
      const idx = probs.findIndex(x=>x.id===p.id);
      if(idx<0) return;
      const newDesc = prompt('ç¼–è¾‘é¢˜ç›®æè¿°ï¼ˆå¤šè¡Œå¯ç²˜è´´ï¼‰ï¼š', probs[idx].desc || '');
      if(newDesc!==null) probs[idx].desc = newDesc;
      const newIdea = prompt('ç¼–è¾‘è§£é¢˜æ€è·¯ï¼š', probs[idx].idea || '');
      if(newIdea!==null) probs[idx].idea = newIdea;
      const newMistake = prompt('ç¼–è¾‘é”™è¯¯æ€»ç»“ï¼š', probs[idx].mistake || '');
      if(newMistake!==null) probs[idx].mistake = newMistake;
      saveJSON(STORAGE_KEYS.problems, probs);
      alert('é¢˜ç›®ä¿¡æ¯å·²æ›´æ–°ï¼ˆå·²ä¿å­˜ï¼‰');
      modalRoot.style.display='none'; modalRoot.innerHTML=''; renderHomeList(); renderCategoryList();
    });
    document.getElementById('modal-run').addEventListener('click', ()=>{
      const out = document.getElementById('modal-run-output'); out.style.display='block'; out.innerText = 'è¿è¡Œä»…ä¸ºæ¨¡æ‹Ÿï¼ˆæ­¤ç‰ˆæœ¬ä¸æ‰§è¡Œç”¨æˆ·ä»£ç ï¼‰ï¼Œä½ å¯ä»¥æŠŠæµ‹è¯•ç»“æœå†™åˆ°æ­¤å¤„æˆ–æ‰‹åŠ¨ç²˜è´´ã€‚';
    });
  }

  // ---------- small actions for add page ----------
  function loadSampleCode(){ const lang = document.getElementById('code-lang').value; let sample=''; if(lang==='JavaScript') sample = `// JS ç¤ºä¾‹\nfunction maxSubArray(nums){\n  let cur=0, ans=-Infinity;\n  for(const x of nums){ cur = Math.max(x, cur + x); ans = Math.max(ans, cur); }\n  return ans;\n}\n`; else if(lang==='Python') sample = `# Python ç¤ºä¾‹\ndef maxSubArray(nums):\n    cur = 0\n    ans = -10**18\n    for x in nums:\n        cur = max(x, cur + x)\n        ans = max(ans, cur)\n    return ans\n`; else if(lang==='Java') sample = `// Java ç¤ºä¾‹\nclass Solution{ public int maxSubArray(int[] nums){ int cur=0, ans=Integer.MIN_VALUE; for(int x: nums){ cur = Math.max(x, cur+x); ans = Math.max(ans, cur);} return ans; } }\n`; else sample = `// C++ ç¤ºä¾‹\nint maxSubArray(vector<int>& nums){ int cur=0, ans=INT_MIN; for(int x: nums){ cur=max(x, cur+x); ans=max(ans,cur);} return ans; }\n`; document.getElementById('problem-code').value = sample; }

  function saveCodeToDraft(){ alert('ä»£ç å·²ä¿å­˜åœ¨æœ¬é¡µï¼ˆä½†è‹¥ä¸ä¿å­˜é¢˜ç›®åˆ™ä¸ä¼šå†™å…¥é¢˜ç›®è®°å½•ï¼‰'); }

  // ---------- Export/Import initial rendering ----------
  renderHomeList(); renderNotes(); renderCalendar(currentDate); renderResourceList(); renderCategoryList();

  // ---------- Keyboard shortcuts ----------
  document.addEventListener('keydown', function(e){ if(e.ctrlKey && e.key==='Enter'){ const active = document.querySelector('.section.active'); if(active && active.id==='notes') saveNote(); if(active && active.id==='add') saveProblem(); } });

</script>
</body>
</html>
