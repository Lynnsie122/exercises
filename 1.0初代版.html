<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CodeTracker - æˆ‘çš„åˆ·é¢˜æ—¥è®°</title>
    <!-- å¼•å…¥ Tailwind CSS ç”¨äºå¿«é€Ÿå¸ƒå±€ -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- å¼•å…¥ Marked.js ç”¨äºè§£æ Markdown -->
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <!-- å¼•å…¥ Chart.js ç”¨äºæ•°æ®å¯è§†åŒ– -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    
    <style>
        /* è‡ªå®šä¹‰æ ·å¼è¦†ç›– */
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background-color: #f7f8fa; }
        .nav-item.active { border-bottom: 2px solid #2563eb; color: #2563eb; font-weight: 600; }
        .calendar-day { min-height: 100px; border: 1px solid #e5e7eb; transition: all 0.2s; }
        .calendar-day:hover { background-color: #f9fafb; }
        .problem-tag { font-size: 0.75rem; padding: 2px 8px; border-radius: 12px; margin-right: 4px; }
        .tag-easy { background-color: #e0f2fe; color: #0284c7; }
        .tag-medium { background-color: #fef9c3; color: #ca8a04; }
        .tag-hard { background-color: #fee2e2; color: #dc2626; }
        
        /* ç¼–è¾‘å™¨æ¨¡æ‹Ÿ */
        .code-editor { 
            font-family: 'Courier New', Courier, monospace; 
            background: #1e1e1e; 
            color: #d4d4d4; 
            min-height: 200px; /* Make it visible */
            resize: vertical; /* Allow resizing */
        }
        .code-block-display, .markdown-content-display { /* For displaying code/markdown in solution/insight tabs */
            font-family: 'Courier New', Courier, monospace; 
            background: #f0f0f0; 
            color: #333; 
            padding: 1rem; 
            border-radius: 0.375rem; 
            overflow-x: auto;
            white-space: pre-wrap;
            word-break: break-all;
            line-height: 1.5;
            font-size: 0.875rem;
        }
        .markdown-content-display {
            font-family: inherit; /* Use body font for general markdown */
            background: none;
            padding: 0;
            overflow: visible;
            white-space: normal;
            word-break: normal;
        }

        /* æ ‡ç­¾é€‰æ‹©å™¨æ ·å¼ */
        .tag-dropdown-container { position: relative; display: inline-block; width: 100%; }
        .tag-dropdown { 
            position: absolute; 
            top: 100%; 
            left: 0; 
            right: 0; 
            background-color: white; 
            border: 1px solid #d1d5db; 
            border-radius: 0.375rem; 
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
            max-height: 200px;
            overflow-y: auto;
            z-index: 10;
        }
        .tag-dropdown-item { 
            padding: 0.5rem 0.75rem; 
            cursor: pointer; 
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .tag-dropdown-item:hover { background-color: #f3f4f6; }
        .selected-tag { 
            display: inline-flex; 
            align-items: center; 
            background-color: #e5e7eb; 
            padding: 0.25rem 0.5rem; 
            border-radius: 0.375rem; 
            margin-right: 0.5rem; 
            margin-bottom: 0.5rem;
            font-size: 0.875rem;
        }
        .selected-tag button { 
            margin-left: 0.5rem; 
            font-weight: bold; 
            color: #4b5563; 
        }

        /* é¢˜ç›®è¯¦æƒ…é¡µå¸ƒå±€ */
        .leetcode-layout { 
            display: grid; 
            grid-template-columns: 1fr; /* Default to single column for mobile */
            gap: 1rem; 
            min-height: calc(100vh - 120px); /* Adjust height for nav and footer if any */
        }
        @media (min-width: 768px) { /* Medium screens and up */
            .leetcode-layout { 
                grid-template-columns: 1fr 1fr; /* Two columns for desktop */
                min-height: calc(100vh - 120px);
            }
        }
        .detail-tab-button {
            padding: 0.5rem 1rem;
            border-bottom: 2px solid transparent;
            transition: all 0.2s;
        }
        .detail-tab-button.active {
            border-bottom: 2px solid #2563eb;
            color: #2563eb;
            font-weight: 600;
        }

        /* Markdown prose styling */
        .prose :where(h1):not(:where([class~="not-prose"] *)) { font-size: 1.875em; margin-top: 1.5em; margin-bottom: 0.8333333em; font-weight: 700; }
        .prose :where(h2):not(:where([class~="not-prose"] *)) { font-size: 1.5em; margin-top: 1.25em; margin-bottom: 0.8333333em; font-weight: 600; }
        .prose :where(h3):not(:where([class~="not-prose"] *)) { font-size: 1.25em; margin-top: 1em; margin-bottom: 0.5em; font-weight: 600; }
        .prose :where(p):not(:where([class~="not-prose"] *)) { margin-top: 1em; margin-bottom: 1em; }
        .prose :where(ul):not(:where([class~="not-prose"] *)) { margin-top: 1em; margin-bottom: 1em; padding-left: 1.5em; list-style-type: disc; }
        .prose :where(ol):not(:where([class~="not-prose"] *)) { margin-top: 1em; margin-bottom: 1em; padding-left: 1.5em; list-style-type: decimal; }
        .prose :where(li):not(:where([class~="not-prose"] *)) { margin-top: 0.5em; margin-bottom: 0.5em; }
        .prose :where(a):not(:where([class~="not-prose"] *)) { color: #2563eb; text-decoration: underline; }
        .prose :where(pre):not(:where([class~="not-prose"] *)) { background-color: #e5e7eb; color: #374151; padding: 1em; border-radius: 0.375rem; overflow-x: auto; margin-top: 1em; margin-bottom: 1em; }
        .prose :where(code):not(:where([class~="not-prose"] *)) { background-color: #e5e7eb; padding: 0.2em 0.4em; border-radius: 0.25rem; font-size: 0.875em; }
        .prose :where(blockquote):not(:where([class~="not-prose"] *)) { border-left: 4px solid #d1d5db; padding-left: 1em; color: #6b7280; margin-top: 1em; margin-bottom: 1em; }
    </style>
</head>
<body class="text-gray-800">

    <!-- é¡¶éƒ¨å¯¼èˆªæ  -->
    <nav class="bg-white shadow-sm fixed w-full z-10 top-0 h-16">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 h-full flex justify-between items-center">
            <div class="flex items-center">
                <div class="text-2xl font-bold text-blue-600 mr-8">CodeTracker</div>
                <div class="hidden md:flex space-x-8 h-16">
                    <button onclick="router('home')" id="nav-home" class="nav-item flex items-center px-1 pt-1 text-sm font-medium text-gray-500 hover:text-gray-700">é¦–é¡µ</button>
                    <button onclick="router('problems')" id="nav-problems" class="nav-item flex items-center px-1 pt-1 text-sm font-medium text-gray-500 hover:text-gray-700">é¢˜åº“/åˆ†ç±»</button>
                    <button onclick="router('calendar')" id="nav-calendar" class="nav-item flex items-center px-1 pt-1 text-sm font-medium text-gray-500 hover:text-gray-700">æ—¥å†</button>
                    <button onclick="router('insights')" id="nav-insights" class="nav-item flex items-center px-1 pt-1 text-sm font-medium text-gray-500 hover:text-gray-700">å¿ƒå¾—æ„Ÿæ‚Ÿ</button>
                    <button onclick="router('resources')" id="nav-resources" class="nav-item flex items-center px-1 pt-1 text-sm font-medium text-gray-500 hover:text-gray-700">èµ„æº</button>
                </div>
            </div>
            <div>
                <button onclick="showAddModal()" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-md text-sm font-medium shadow transition">+ è®°å½•æ–°é¢˜</button>
            </div>
        </div>
    </nav>

    <!-- é¡µé¢å†…å®¹å®¹å™¨ -->
    <main class="pt-20 max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 min-h-screen pb-10">
        
        <!-- 1. é¦–é¡µ (Dashboard) -->
        <section id="page-home" class="page-section">
            <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
                <!-- æ•°æ®ç»Ÿè®¡å¡ç‰‡ -->
                <div class="bg-white p-6 rounded-lg shadow-sm border border-gray-100">
                    <h3 class="text-lg font-semibold text-gray-700 mb-2">æ€»åˆ·é¢˜æ•°</h3>
                    <p class="text-4xl font-bold text-blue-600" id="total-problems-count">0</p>
                </div>
                <div class="bg-white p-6 rounded-lg shadow-sm border border-gray-100">
                    <h3 class="text-lg font-semibold text-gray-700 mb-2">æœ¬æœˆæ´»è·ƒå¤©æ•°</h3>
                    <p class="text-4xl font-bold text-green-600" id="active-days">0</p>
                </div>
                <div class="bg-white p-6 rounded-lg shadow-sm border border-gray-100 flex items-center justify-center">
                    <div style="width: 150px; height: 150px;">
                        <canvas id="difficultyChart"></canvas>
                    </div>
                </div>
            </div>

            <h2 class="text-xl font-bold mb-4 text-gray-800">æœ€è¿‘ç»ƒä¹ </h2>
            <div class="bg-white rounded-lg shadow-sm overflow-hidden">
                <table class="min-w-full divide-y divide-gray-200">
                    <thead class="bg-gray-50">
                        <tr>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">é¢˜ç›®</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">éš¾åº¦</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">æ ‡ç­¾</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">æ—¥æœŸ</th>
                        </tr>
                    </thead>
                    <tbody class="bg-white divide-y divide-gray-200" id="recent-problems-list">
                        <!-- JSå¡«å……å†…å®¹ -->
                    </tbody>
                </table>
            </div>
        </section>

        <!-- 2. é¢˜åº“/åˆ†ç±»é¡µ (Problems) -->
        <section id="page-problems" class="page-section hidden">
            <div class="flex flex-col md:flex-row gap-6">
                <!-- å·¦ä¾§ä¾§è¾¹æ ï¼šåˆ†ç±» -->
                <div class="w-full md:w-1/4">
                    <div class="bg-white rounded-lg shadow-sm p-4 sticky top-24">
                        <h3 class="font-bold text-lg mb-4 flex justify-between items-center">
                            æ ‡ç­¾åˆ†ç±»
                            <button onclick="showAddTagModal()" class="text-blue-600 text-sm hover:underline">+ æ–°å»ºåˆ†ç±»</button>
                        </h3>
                        <div class="flex flex-wrap gap-2" id="category-tags">
                            <button class="bg-gray-800 text-white px-3 py-1 rounded-full text-sm transition" onclick="renderProblemList('all')">å…¨éƒ¨</button>
                            <!-- JSç”Ÿæˆæ ‡ç­¾ -->
                        </div>
                    </div>
                </div>

                <!-- å³ä¾§ï¼šåˆ—è¡¨ä¸æœç´¢ -->
                <div class="w-full md:w-3/4">
                    <div class="mb-4 flex gap-2">
                        <input type="text" id="search-input" placeholder="æœç´¢é¢˜ç›®åç§°æˆ–ç¼–å·..." class="w-full border border-gray-300 rounded-md px-4 py-2 focus:ring-2 focus:ring-blue-500 focus:outline-none">
                        <button onclick="renderProblemList()" class="bg-blue-600 text-white px-6 py-2 rounded-md">æœç´¢</button>
                        <button onclick="clearProblemSearch()" class="bg-gray-200 text-gray-700 px-6 py-2 rounded-md hover:bg-gray-300">æ¸…ç©º</button>
                    </div>
                    <div class="bg-white rounded-lg shadow-sm overflow-hidden">
                        <table class="min-w-full divide-y divide-gray-200">
                            <thead class="bg-gray-50">
                                <tr>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider w-16">çŠ¶æ€</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">é¢˜ç›®</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider w-24">éš¾åº¦</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider w-24">æ“ä½œ</th>
                                </tr>
                            </thead>
                            <tbody class="bg-white divide-y divide-gray-200" id="all-problems-list">
                                <!-- JSå¡«å…… -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </section>

        <!-- 3. æ—¥å†é¡µ (Calendar) -->
        <section id="page-calendar" class="page-section hidden">
            <div class="bg-white rounded-lg shadow-sm p-6">
                <div class="flex justify-between items-center mb-6">
                    <h2 class="text-2xl font-bold" id="calendar-month-year"></h2>
                    <div class="space-x-2">
                        <button onclick="changeMonth(-1)" class="px-3 py-1 border rounded hover:bg-gray-50">&lt;</button>
                        <button onclick="changeMonth(1)" class="px-3 py-1 border rounded hover:bg-gray-50">&gt;</button>
                    </div>
                </div>
                <div class="grid grid-cols-7 gap-0 border-t border-l border-gray-200">
                    <!-- æ˜ŸæœŸå¤´ -->
                    <div class="p-2 text-center font-bold bg-gray-50 border-r border-b border-gray-200">æ—¥</div>
                    <div class="p-2 text-center font-bold bg-gray-50 border-r border-b border-gray-200">ä¸€</div>
                    <div class="p-2 text-center font-bold bg-gray-50 border-r border-b border-gray-200">äºŒ</div>
                    <div class="p-2 text-center font-bold bg-gray-50 border-r border-b border-gray-200">ä¸‰</div>
                    <div class="p-2 text-center font-bold bg-gray-50 border-r border-b border-gray-200">å››</div>
                    <div class="p-2 text-center font-bold bg-gray-50 border-r border-b border-gray-200">äº”</div>
                    <div class="p-2 text-center font-bold bg-gray-50 border-r border-b border-gray-200">å…­</div>
                </div>
                <div class="grid grid-cols-7 gap-0 border-l border-gray-200" id="calendar-grid">
                    <!-- JSç”Ÿæˆæ—¥å†æ ¼å­ -->
                </div>
            </div>
        </section>

        <!-- 4. é¢˜ç›®è¯¦æƒ…é¡µ (Details) -->
        <section id="page-detail" class="page-section hidden">
            <!-- è¿”å›æŒ‰é’®ï¼šæ ¹æ®ä¸Šä¸€ä¸ªé¡µé¢å†³å®šè¿”å›å“ªé‡Œ -->
            <button onclick="goBack()" class="mb-4 text-blue-600 hover:underline">&larr; è¿”å›</button>
            <div class="leetcode-layout">
                <!-- å·¦ä¾§ï¼šé¢˜ç›®è¯¦æƒ… -->
                <div class="bg-white rounded-lg shadow-sm flex flex-col border border-gray-200 overflow-hidden">
                    <div class="flex border-b border-gray-200">
                        <button id="tab-btn-problem" onclick="showDetailTab('problem')" class="detail-tab-button px-4 py-2 text-sm text-gray-600 hover:text-blue-600 active">é¢˜ç›®</button>
                        <button id="tab-btn-solution" onclick="showDetailTab('solution')" class="detail-tab-button px-4 py-2 text-sm text-gray-600 hover:text-blue-600">æˆ‘çš„é¢˜è§£</button>
                        <button id="tab-btn-submissions" onclick="showDetailTab('submissions')" class="detail-tab-button px-4 py-2 text-sm text-gray-600 hover:text-blue-600">æäº¤è®°å½•</button>
                    </div>

                    <div id="detail-tab-content-problem" class="p-6 overflow-y-auto flex-1">
                        <div class="flex justify-between items-start mb-4">
                            <h1 class="text-2xl font-bold" id="detail-title">é¢˜ç›®åç§°</h1>
                            <span id="detail-difficulty" class="px-2 py-1 rounded text-xs font-bold">éš¾åº¦</span>
                        </div>
                        <div class="flex gap-2 mb-6" id="detail-tags"></div>
                        <div class="prose max-w-none text-gray-700" id="detail-content">
                            <!-- Markdown å†…å®¹ -->
                        </div>
                        <div class="mt-8 pt-4 border-t border-gray-200" id="detail-examples-section">
                            <h3 class="text-lg font-semibold mb-3">ç¤ºä¾‹</h3>
                            <div id="detail-examples">
                                <!-- JSå¡«å……ç¤ºä¾‹ -->
                            </div>
                        </div>
                    </div>

                    <div id="detail-tab-content-solution" class="p-6 overflow-y-auto flex-1 hidden">
                        <h2 class="text-xl font-bold mb-4">æˆ‘çš„é¢˜è§£å’Œç¬”è®°</h2>
                        <div class="code-block-display" id="detail-solution-code">
                            <!-- é¢˜è§£ä»£ç  -->
                        </div>
                    </div>

                    <div id="detail-tab-content-submissions" class="p-6 overflow-y-auto flex-1 hidden">
                        <h2 class="text-xl font-bold mb-4">æäº¤è®°å½• (æ¨¡æ‹Ÿ)</h2>
                        <p class="text-gray-600">æ­¤åŠŸèƒ½ç›®å‰ä»…ä¸ºå ä½ç¬¦ã€‚ç”±äºæ˜¯çº¯å‰ç«¯åº”ç”¨ï¼Œæ— æ³•å®ç°çœŸæ­£çš„ä»£ç æäº¤å’Œè¿è¡Œè®°å½•ã€‚</p>
                        <ul class="list-disc pl-5 mt-4 text-gray-700">
                            <li>2023-12-01 10:30 - é€šè¿‡ (æ¨¡æ‹Ÿ)</li>
                            <li>2023-11-28 15:45 - é”™è¯¯ (æ¨¡æ‹Ÿ)</li>
                        </ul>
                    </div>

                </div>

                <!-- å³ä¾§ï¼šä»£ç ç¼–è¾‘åŒºåŸŸ -->
                <div class="bg-white rounded-lg shadow-sm flex flex-col border border-gray-200 overflow-hidden">
                    <div class="bg-gray-100 px-4 py-2 border-b border-gray-200 font-medium text-sm flex justify-between items-center">
                        <span>ä»£ç ç¼–è¾‘å™¨</span>
                        <div class="flex space-x-2">
                            <button onclick="simulateRunCode()" class="bg-green-500 hover:bg-green-600 text-white px-3 py-1 rounded text-xs transition">è¿è¡Œ</button>
                            <button onclick="simulateSubmitCode()" class="bg-blue-600 hover:bg-blue-700 text-white px-3 py-1 rounded text-xs transition">æäº¤</button>
                        </div>
                    </div>
                    <textarea 
                        id="detail-code-editor" 
                        class="flex-1 p-4 code-editor w-full h-full resize-none border-none focus:outline-none" 
                        onblur="saveCodeChanges()">// åœ¨è¿™é‡Œå†™ä½ çš„ä»£ç ...</textarea>
                    
                    <div class="bg-gray-100 px-4 py-2 border-t border-gray-200 text-sm text-gray-600">
                        <p>ğŸ’¡ **æç¤ºï¼š** è¿™æ˜¯ä¸€ä¸ªæ¨¡æ‹Ÿç¼–è¾‘å™¨ã€‚ä»£ç è¡¥å…¨ã€è‡ªåŠ¨æç¤ºå’Œåœ¨çº¿è¿è¡ŒåŠŸèƒ½éœ€è¦åç«¯æ”¯æŒï¼Œç›®å‰æ— æ³•å®ç°ã€‚</p>
                        <p>ä½ çš„ä»£ç ä¼šåœ¨ä½ åˆ‡æ¢é¡µé¢æˆ–å…³é—­æ­¤é¡µé¢æ—¶è‡ªåŠ¨ä¿å­˜åˆ°æœ¬åœ°ã€‚</p>
                    </div>
                </div>
            </div>
        </section>

        <!-- 5. å¿ƒå¾—æ„Ÿæ‚Ÿé¡µ (Insights) -->
        <section id="page-insights" class="page-section hidden">
            <h2 class="text-2xl font-bold mb-6 text-gray-800 flex justify-between items-center">
                æˆ‘çš„å¿ƒå¾—æ„Ÿæ‚Ÿ
                <button onclick="showAddInsightModal()" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-md text-sm font-medium shadow transition">+ è®°å½•æ–°æ„Ÿæ‚Ÿ</button>
            </h2>

            <div class="mb-4 flex flex-wrap gap-2 items-center">
                <span class="text-sm font-medium text-gray-700">ç­›é€‰æ ‡ç­¾:</span>
                <button class="bg-gray-800 text-white px-3 py-1 rounded-full text-sm transition" onclick="renderInsights('all')">å…¨éƒ¨</button>
                <div id="insight-filter-tags" class="flex flex-wrap gap-2">
                    <!-- JSç”Ÿæˆæ ‡ç­¾ -->
                </div>
                <input type="date" id="insight-filter-date" class="border border-gray-300 rounded-md px-3 py-1 text-sm" onchange="renderInsights()">
                <button onclick="clearInsightFilters()" class="bg-gray-200 text-gray-700 px-3 py-1 rounded-md hover:bg-gray-300 text-sm">æ¸…ç©ºç­›é€‰</button>
            </div>

            <div id="insights-grid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                <!-- JSå¡«å……å¿ƒå¾—æ„Ÿæ‚Ÿå¡ç‰‡ -->
            </div>
            <p id="no-insights-message" class="text-center text-gray-500 mt-8 hidden">æš‚æ— å¿ƒå¾—æ„Ÿæ‚Ÿã€‚</p>
        </section>

        <!-- 6. èµ„æºé¡µ (Resources) -->
        <section id="page-resources" class="page-section hidden">
            <h2 class="text-2xl font-bold mb-6 text-gray-800 flex justify-between items-center">
                æˆ‘çš„å­¦ä¹ èµ„æº
                <button onclick="showAddResourceModal()" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-md text-sm font-medium shadow transition">+ æ·»åŠ æ–°èµ„æº</button>
            </h2>

            <div class="bg-white rounded-lg shadow-sm overflow-hidden">
                <table class="min-w-full divide-y divide-gray-200">
                    <thead class="bg-gray-50">
                        <tr>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">æ ‡é¢˜</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">é“¾æ¥</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">æè¿°</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider w-24">æ—¥æœŸ</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider w-16">æ“ä½œ</th>
                        </tr>
                    </thead>
                    <tbody class="bg-white divide-y divide-gray-200" id="resources-list">
                        <!-- JSå¡«å……èµ„æºåˆ—è¡¨ -->
                    </tbody>
                </table>
                <p id="no-resources-message" class="text-center text-gray-500 py-6 hidden">æš‚æ— å­¦ä¹ èµ„æºã€‚</p>
            </div>
        </section>

    </main>

    <!-- æ·»åŠ é¢˜ç›®æ¨¡æ€æ¡† -->
    <div id="add-modal" class="fixed inset-0 bg-gray-600 bg-opacity-50 hidden overflow-y-auto h-full w-full z-50">
        <div class="relative top-10 mx-auto p-5 border w-full max-w-2xl shadow-lg rounded-md bg-white">
            <div class="mt-3">
                <h3 class="text-lg leading-6 font-medium text-gray-900 mb-4">è®°å½•æ–°é¢˜ç›®</h3>
                <form id="add-form" class="space-y-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700">é¢˜ç›®åç§°</label>
                        <input type="text" id="inp-title" required class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm p-2">
                    </div>
                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700">éš¾åº¦</label>
                            <select id="inp-difficulty" class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm p-2">
                                <option value="Easy">ç®€å•</option>
                                <option value="Medium">ä¸­ç­‰</option>
                                <option value="Hard">å›°éš¾</option>
                            </select>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700">æ—¥æœŸ</label>
                            <input type="date" id="inp-date" required class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm p-2">
                        </div>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700">æ ‡ç­¾ (ç‚¹å‡»é€‰æ‹©æˆ–è¾“å…¥æ–°æ ‡ç­¾)</label>
                        <div class="tag-dropdown-container">
                            <div id="selected-tags-display" class="flex flex-wrap gap-1 p-2 border border-gray-300 rounded-md bg-gray-50 min-h-[38px]">
                                <!-- å·²é€‰æ ‡ç­¾ä¼šæ˜¾ç¤ºåœ¨è¿™é‡Œ -->
                            </div>
                            <input type="text" id="inp-tags-input" placeholder="è¾“å…¥æ ‡ç­¾åæˆ–ä»ä¸‹æ–¹é€‰æ‹©..." 
                                class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm p-2"
                                onfocus="showTagDropdown()" onblur="hideTagDropdownDelayed()">
                            <div id="tag-dropdown" class="tag-dropdown hidden">
                                <!-- æ ‡ç­¾é€‰é¡¹ä¼šåœ¨è¿™é‡Œæ¸²æŸ“ -->
                            </div>
                        </div>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700">é¢˜ç›®æè¿° (Markdown)</label>
                        <textarea id="inp-desc" rows="3" class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm p-2"></textarea>
                    </div>

                    <!-- ç¤ºä¾‹æ¨¡å— -->
                    <div>
                        <div class="flex justify-between items-center mb-2">
                            <label class="block text-sm font-medium text-gray-700">ç¤ºä¾‹</label>
                            <button type="button" onclick="addExampleFields()" class="text-blue-600 text-sm hover:underline">+ æ·»åŠ ç¤ºä¾‹</button>
                        </div>
                        <div id="example-fields-container" class="space-y-3 p-3 border border-gray-200 rounded-md bg-gray-50">
                            <!-- ç¤ºä¾‹è¾“å…¥æ¡†å°†åœ¨è¿™é‡ŒåŠ¨æ€æ·»åŠ  -->
                            <p class="text-xs text-gray-500">ç‚¹å‡» "+ æ·»åŠ ç¤ºä¾‹" æŒ‰é’®æ¥æ·»åŠ è¾“å…¥/è¾“å‡ºç¤ºä¾‹ã€‚</p>
                        </div>
                    </div>

                    <div>
                        <label class="block text-sm font-medium text-gray-700">ä»£ç /ç¬”è®°</label>
                        <textarea id="inp-code" rows="5" class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm p-2 font-mono text-sm bg-gray-50"></textarea>
                    </div>
                    <div class="flex justify-end gap-3 mt-4">
                        <button type="button" onclick="closeAddModal()" class="bg-gray-200 px-4 py-2 rounded-md hover:bg-gray-300">å–æ¶ˆ</button>
                        <button type="submit" class="bg-blue-600 text-white px-4 py-2 rounded-md hover:bg-blue-700">ä¿å­˜</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- æ–°å»ºåˆ†ç±»æ¨¡æ€æ¡† -->
    <div id="add-tag-modal" class="fixed inset-0 bg-gray-600 bg-opacity-50 hidden overflow-y-auto h-full w-full z-50">
        <div class="relative top-20 mx-auto p-5 border w-full max-w-md shadow-lg rounded-md bg-white">
            <div class="mt-3">
                <h3 class="text-lg leading-6 font-medium text-gray-900 mb-4">æ–°å»ºåˆ†ç±»</h3>
                <form id="add-tag-form" class="space-y-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700">åˆ†ç±»åç§°</label>
                        <input type="text" id="inp-new-tag" required class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm p-2">
                    </div>
                    <div class="flex justify-end gap-3 mt-4">
                        <button type="button" onclick="closeAddTagModal()" class="bg-gray-200 px-4 py-2 rounded-md hover:bg-gray-300">å–æ¶ˆ</button>
                        <button type="submit" class="bg-blue-600 text-white px-4 py-2 rounded-md hover:bg-blue-700">æ·»åŠ </button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- æ·»åŠ å¿ƒå¾—æ„Ÿæ‚Ÿæ¨¡æ€æ¡† -->
    <div id="add-insight-modal" class="fixed inset-0 bg-gray-600 bg-opacity-50 hidden overflow-y-auto h-full w-full z-50">
        <div class="relative top-10 mx-auto p-5 border w-full max-w-2xl shadow-lg rounded-md bg-white">
            <div class="mt-3">
                <h3 class="text-lg leading-6 font-medium text-gray-900 mb-4">è®°å½•æ–°å¿ƒå¾—æ„Ÿæ‚Ÿ</h3>
                <form id="add-insight-form" class="space-y-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700">æ ‡é¢˜</label>
                        <input type="text" id="inp-insight-title" required class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm p-2">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700">æ—¥æœŸ</label>
                        <input type="date" id="inp-insight-date" required class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm p-2">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700">æ ‡ç­¾ (ç‚¹å‡»é€‰æ‹©æˆ–è¾“å…¥æ–°æ ‡ç­¾)</label>
                        <div class="tag-dropdown-container">
                            <div id="selected-insight-tags-display" class="flex flex-wrap gap-1 p-2 border border-gray-300 rounded-md bg-gray-50 min-h-[38px]">
                                <!-- å·²é€‰æ ‡ç­¾ä¼šæ˜¾ç¤ºåœ¨è¿™é‡Œ -->
                            </div>
                            <input type="text" id="inp-insight-tags-input" placeholder="è¾“å…¥æ ‡ç­¾åæˆ–ä»ä¸‹æ–¹é€‰æ‹©..." 
                                class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm p-2"
                                onfocus="showInsightTagDropdown()" onblur="hideInsightTagDropdownDelayed()">
                            <div id="insight-tag-dropdown" class="tag-dropdown hidden">
                                <!-- æ ‡ç­¾é€‰é¡¹ä¼šåœ¨è¿™é‡Œæ¸²æŸ“ -->
                            </div>
                        </div>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700">å†…å®¹ (Markdown)</label>
                        <textarea id="inp-insight-content" rows="8" class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm p-2"></textarea>
                    </div>
                    <div class="flex justify-end gap-3 mt-4">
                        <button type="button" onclick="closeAddInsightModal()" class="bg-gray-200 px-4 py-2 rounded-md hover:bg-gray-300">å–æ¶ˆ</button>
                        <button type="submit" class="bg-blue-600 text-white px-4 py-2 rounded-md hover:bg-blue-700">ä¿å­˜</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- å¿ƒå¾—æ„Ÿæ‚Ÿè¯¦æƒ…æ¨¡æ€æ¡† (ç”¨äºæŸ¥çœ‹å®Œæ•´å†…å®¹) -->
    <div id="insight-detail-modal" class="fixed inset-0 bg-gray-600 bg-opacity-50 hidden overflow-y-auto h-full w-full z-50">
        <div class="relative top-10 mx-auto p-5 border w-full max-w-3xl shadow-lg rounded-md bg-white">
            <div class="flex justify-between items-center mb-4 border-b pb-3">
                <h3 class="text-2xl font-bold text-gray-900" id="insight-detail-title"></h3>
                <button onclick="closeInsightDetailModal()" class="text-gray-500 hover:text-gray-800 text-2xl">&times;</button>
            </div>
            <div class="text-sm text-gray-600 mb-4">
                <span id="insight-detail-date" class="mr-3"></span>
                <span id="insight-detail-tags" class="flex flex-wrap gap-1"></span>
            </div>
            <div id="insight-detail-content" class="prose max-w-none text-gray-700 markdown-content-display">
                <!-- æ„Ÿæ‚Ÿå†…å®¹ Markdown æ¸²æŸ“ -->
            </div>
            <div class="flex justify-end mt-6">
                <button type="button" onclick="closeInsightDetailModal()" class="bg-gray-200 px-4 py-2 rounded-md hover:bg-gray-300">å…³é—­</button>
            </div>
        </div>
    </div>


    <!-- æ·»åŠ èµ„æºæ¨¡æ€æ¡† -->
    <div id="add-resource-modal" class="fixed inset-0 bg-gray-600 bg-opacity-50 hidden overflow-y-auto h-full w-full z-50">
        <div class="relative top-20 mx-auto p-5 border w-full max-w-xl shadow-lg rounded-md bg-white">
            <div class="mt-3">
                <h3 class="text-lg leading-6 font-medium text-gray-900 mb-4">æ·»åŠ æ–°èµ„æº</h3>
                <form id="add-resource-form" class="space-y-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700">æ ‡é¢˜</label>
                        <input type="text" id="inp-resource-title" required class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm p-2">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700">é“¾æ¥</label>
                        <input type="url" id="inp-resource-url" required class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm p-2">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700">æè¿° (Markdown)</label>
                        <textarea id="inp-resource-desc" rows="3" class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm p-2"></textarea>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700">æ—¥æœŸ</label>
                        <input type="date" id="inp-resource-date" required class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm p-2">
                    </div>
                    <div class="flex justify-end gap-3 mt-4">
                        <button type="button" onclick="closeAddResourceModal()" class="bg-gray-200 px-4 py-2 rounded-md hover:bg-gray-300">å–æ¶ˆ</button>
                        <button type="submit" class="bg-blue-600 text-white px-4 py-2 rounded-md hover:bg-blue-700">ä¿å­˜</button>
                    </div>
                </form>
            </div>
        </div>
    </div>


    <script>
        // --- 1. æ•°æ®ç®¡ç† (æ¨¡æ‹Ÿæ•°æ®åº“) ---
        let problems = JSON.parse(localStorage.getItem('leetcode_tracker_data')) || [];
        let insights = JSON.parse(localStorage.getItem('leetcode_tracker_insights')) || [];
        let resources = JSON.parse(localStorage.getItem('leetcode_tracker_resources')) || [];
        let tags = JSON.parse(localStorage.getItem('leetcode_tracker_tags')) || ['æ•°ç»„', 'é“¾è¡¨', 'å“ˆå¸Œè¡¨', 'åŠ¨æ€è§„åˆ’', 'äºŒå‰æ ‘', 'å›¾', 'æ’åº', 'æœç´¢']; // é¢„è®¾æ ‡ç­¾
        
        // ç”¨äºç”Ÿæˆå”¯ä¸€IDï¼Œç¡®ä¿è·¨æ‰€æœ‰æ•°æ®ç±»å‹ä¸é‡å¤
        let lastUsedId = Math.max(
            problems.length > 0 ? Math.max(...problems.map(p => p.id)) : 0,
            insights.length > 0 ? Math.max(...insights.map(i => i.id)) : 0,
            resources.length > 0 ? Math.max(...resources.map(r => r.id)) : 0
        ) + 1;

        function getNextId() {
            return lastUsedId++;
        }

        function saveData() {
            localStorage.setItem('leetcode_tracker_data', JSON.stringify(problems));
            localStorage.setItem('leetcode_tracker_insights', JSON.stringify(insights));
            localStorage.setItem('leetcode_tracker_resources', JSON.stringify(resources));
            localStorage.setItem('leetcode_tracker_tags', JSON.stringify(tags));
            initDashboard(); // æ›´æ–°æ•°æ®ååˆ·æ–°é¦–é¡µ
            renderProblemList(); // åˆ·æ–°é¢˜åº“é¡µé¢
            renderCalendar(); // åˆ·æ–°æ—¥å†é¡µé¢
            renderInsights(); // åˆ·æ–°å¿ƒå¾—æ„Ÿæ‚Ÿé¡µé¢
            renderResources(); // åˆ·æ–°èµ„æºé¡µé¢
        }

        // --- 2. è·¯ç”±æ§åˆ¶ ---
        function router(pageName, id = null) {
            document.querySelectorAll('.page-section').forEach(el => el.classList.add('hidden'));
            document.querySelectorAll('.nav-item').forEach(el => el.classList.remove('active'));

            if (pageName === 'detail' && id) {
                document.getElementById('page-detail').classList.remove('hidden');
                currentProblemIdInDetail = id; // è®¾ç½®å½“å‰è¯¦æƒ…é¡µé¢˜ç›®ID
                renderDetail(id);
            } else {
                document.getElementById(`page-${pageName}`).classList.remove('hidden');
                const navBtn = document.getElementById(`nav-${pageName}`);
                if (navBtn) navBtn.classList.add('active');
                currentProblemIdInDetail = null; // ç¦»å¼€è¯¦æƒ…é¡µæ—¶æ¸…ç©ºID
            }

            if (pageName !== 'detail') { // è®°å½•éè¯¦æƒ…é¡µçš„é¡µé¢ï¼Œç”¨äºè¯¦æƒ…é¡µè¿”å›
                lastVisitedPage = pageName;
            }

            if (pageName === 'home') initDashboard();
            if (pageName === 'problems') renderProblemList();
            if (pageName === 'calendar') renderCalendar();
            if (pageName === 'insights') renderInsights();
            if (pageName === 'resources') renderResources();
        }

        let lastVisitedPage = 'home'; // ç”¨äºè¯¦æƒ…é¡µè¿”å›
        let currentProblemIdInDetail = null; // ç”¨äºè®°å½•å½“å‰è¯¦æƒ…é¡µæ˜¾ç¤ºçš„é¢˜ç›®ID

        // è¯¦æƒ…é¡µè¿”å›é€»è¾‘
        function goBack() {
            // åœ¨è¿”å›å‰ï¼Œä¿å­˜å½“å‰ç¼–è¾‘å™¨ä¸­çš„ä»£ç 
            if (currentProblemIdInDetail) {
                saveCodeChanges();
            }
            router(lastVisitedPage);
        }

        // --- 3. é¦–é¡µé€»è¾‘ ---
        let difficultyChartInstance = null;
        function initDashboard() {
            document.getElementById('total-problems-count').innerText = problems.length;
            
            // è®¡ç®—æœ¬æœˆæ´»è·ƒå¤©æ•°
            const now = new Date();
            const thisMonthStr = `${now.getFullYear()}-${String(now.getMonth()+1).padStart(2, '0')}`;
            const activeDays = new Set(problems
                .filter(p => p.date.startsWith(thisMonthStr))
                .map(p => p.date)
            );
            document.getElementById('active-days').innerText = activeDays.size;

            // æ¸²æŸ“æœ€è¿‘åˆ—è¡¨ (å‰5ä¸ª)
            const recentList = [...problems].sort((a, b) => new Date(b.date) - new Date(a.date)).slice(0, 5);
            const tbody = document.getElementById('recent-problems-list');
            tbody.innerHTML = recentList.map(p => `
                <tr class="hover:bg-gray-50 cursor-pointer" onclick="router('detail', ${p.id})">
                    <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">${p.title}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm">
                        <span class="problem-tag ${getDifficultyClass(p.difficulty)}">${getChineseDifficulty(p.difficulty)}</span>
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${p.tags.join(', ')}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${p.date}</td>
                </tr>
            `).join('');

            // æ¸²æŸ“å›¾è¡¨
            const counts = { Easy: 0, Medium: 0, Hard: 0 };
            problems.forEach(p => counts[p.difficulty]++);
            
            const ctx = document.getElementById('difficultyChart').getContext('2d');
            if (difficultyChartInstance) difficultyChartInstance.destroy();
            
            difficultyChartInstance = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: ['ç®€å•', 'ä¸­ç­‰', 'å›°éš¾'],
                    datasets: [{
                        data: [counts.Easy, counts.Medium, counts.Hard],
                        backgroundColor: ['#e0f2fe', '#fef9c3', '#fee2e2'],
                        borderColor: ['#0284c7', '#ca8a04', '#dc2626'],
                        borderWidth: 1
                    }]
                },
                options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false } } }
            });
        }

        // --- 4. é¢˜åº“é¡µé€»è¾‘ ---
        let currentProblemFilterTag = 'all'; // è®°å½•å½“å‰ç­›é€‰æ ‡ç­¾

        function renderProblemList(filterTag = currentProblemFilterTag) {
            currentProblemFilterTag = filterTag; // æ›´æ–°å½“å‰ç­›é€‰æ ‡ç­¾

            // 1. æ¸²æŸ“å·¦ä¾§æ ‡ç­¾
            const tagContainer = document.getElementById('category-tags');
            tagContainer.innerHTML = `<button class="tag-button ${currentProblemFilterTag === 'all' ? 'bg-blue-600 text-white' : 'bg-gray-200 hover:bg-gray-300'} px-3 py-1 rounded-full text-sm transition" onclick="renderProblemList('all')">å…¨éƒ¨</button>`;
            tags.forEach(tag => {
                const isActive = currentProblemFilterTag === tag ? 'bg-blue-600 text-white' : 'bg-gray-200 hover:bg-gray-300';
                tagContainer.innerHTML += `<button class="tag-button ${isActive} px-3 py-1 rounded-full text-sm transition" onclick="renderProblemList('${tag}')">${tag}</button>`;
            });

            // 2. è¿‡æ»¤å’Œæœç´¢
            const searchText = document.getElementById('search-input').value.toLowerCase();
            let filtered = problems.filter(p => {
                const matchTag = currentProblemFilterTag === 'all' || p.tags.includes(currentProblemFilterTag);
                const matchSearch = p.title.toLowerCase().includes(searchText);
                return matchTag && matchSearch;
            });

            // 3. æ¸²æŸ“è¡¨æ ¼
            const tbody = document.getElementById('all-problems-list');
            tbody.innerHTML = filtered.map(p => `
                <tr class="hover:bg-gray-50 cursor-pointer">
                    <td class="px-6 py-4 whitespace-nowrap"><span class="text-green-500">âœ”</span></td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-blue-600 hover:underline" onclick="router('detail', ${p.id})">${p.title}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm"><span class="problem-tag ${getDifficultyClass(p.difficulty)}">${getChineseDifficulty(p.difficulty)}</span></td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm">
                        <button onclick="deleteProblem(${p.id}); event.stopPropagation();" class="text-red-500 hover:text-red-700">åˆ é™¤</button>
                    </td>
                </tr>
            `).join('');
        }

        function clearProblemSearch() {
            document.getElementById('search-input').value = ''; // æ¸…ç©ºæœç´¢æ¡†
            renderProblemList('all'); // é‡æ–°æ¸²æŸ“æ‰€æœ‰é¢˜ç›®
        }


        // --- 5. æ—¥å†é¡µé€»è¾‘ ---
        let currentDate = new Date();
        
        function changeMonth(delta) {
            currentDate.setMonth(currentDate.getMonth() + delta);
            renderCalendar();
        }

        function renderCalendar() {
            const year = currentDate.getFullYear();
            const month = currentDate.getMonth();
            
            document.getElementById('calendar-month-year').innerText = `${year}å¹´ ${month + 1}æœˆ`;
            
            const firstDay = new Date(year, month, 1);
            const lastDay = new Date(year, month + 1, 0);
            const daysInMonth = lastDay.getDate();
            const startingDay = firstDay.getDay(); // 0 is Sunday
            
            const grid = document.getElementById('calendar-grid');
            grid.innerHTML = '';

            // å¡«å……ç©ºç™½
            for (let i = 0; i < startingDay; i++) {
                grid.innerHTML += `<div class="calendar-day bg-gray-50 border-r border-b border-gray-200"></div>`;
            }

            // å¡«å……æ—¥æœŸ
            for (let i = 1; i <= daysInMonth; i++) {
                const dateStr = `${year}-${String(month+1).padStart(2,'0')}-${String(i).padStart(2,'0')}`;
                // æŸ¥æ‰¾å½“å¤©çš„é¢˜ç›®
                const daysProblems = problems.filter(p => p.date === dateStr);
                
                let problemHtml = '';
                // å¦‚æœé¢˜ç›®è¶…è¿‡3ä¸ªï¼Œåˆ†æˆä¸¤åˆ—æ˜¾ç¤º
                const problemContainerClass = daysProblems.length >= 3 ? 'grid grid-cols-2 gap-1' : ''; 
                
                daysProblems.forEach(p => {
                    const colorClass = p.difficulty === 'Easy' ? 'bg-blue-100 text-blue-800' : (p.difficulty === 'Medium' ? 'bg-yellow-100 text-yellow-800' : 'bg-red-100 text-red-800');
                    problemHtml += `<div onclick="router('detail', ${p.id}); event.stopPropagation();" class="text-xs p-1 rounded cursor-pointer truncate ${colorClass}">${p.title}</div>`;
                });

                grid.innerHTML += `
                    <div class="calendar-day p-2 border-r border-b border-gray-200 relative bg-white">
                        <div class="text-sm text-gray-500 font-medium">${i}</div>
                        <div class="mt-1 overflow-y-auto max-h-[80px] ${problemContainerClass}">
                            ${problemHtml}
                        </div>
                    </div>
                `;
            }
        }

        // --- 6. é¢˜ç›®è¯¦æƒ…é¡µé€»è¾‘ ---
        function renderDetail(id) {
            const problem = problems.find(p => p.id === id);
            if (!problem) return;

            // é¢˜ç›®ä¿¡æ¯
            document.getElementById('detail-title').innerText = problem.title;
            const diffBadge = document.getElementById('detail-difficulty');
            diffBadge.innerText = getChineseDifficulty(problem.difficulty); // éš¾åº¦ä¸­æ–‡
            diffBadge.className = `px-2 py-1 rounded text-xs font-bold ${getDifficultyClass(problem.difficulty)}`;

            document.getElementById('detail-tags').innerHTML = problem.tags.map(t => 
                `<span class="bg-gray-200 px-2 py-1 rounded text-xs text-gray-700">${t}</span>`
            ).join('');

            // é¢˜ç›®æè¿°
            document.getElementById('detail-content').innerHTML = marked.parse(problem.desc || 'æš‚æ— æè¿°');
            
            // ç¤ºä¾‹
            const examplesContainer = document.getElementById('detail-examples');
            examplesContainer.innerHTML = '';
            if (problem.examples && problem.examples.length > 0) {
                problem.examples.forEach((example, index) => {
                    examplesContainer.innerHTML += `
                        <div class="mb-4 p-4 border rounded-md bg-gray-50">
                            <p class="font-semibold text-sm mb-2">ç¤ºä¾‹ ${index + 1}:</p>
                            <p class="text-xs font-mono mb-1">è¾“å…¥: <code>${escapeHtml(example.input)}</code></p>
                            <p class="text-xs font-mono">è¾“å‡º: <code>${escapeHtml(example.output)}</code></p>
                        </div>
                    `;
                });
                document.getElementById('detail-examples-section').classList.remove('hidden');
            } else {
                examplesContainer.innerHTML = '<p class="text-sm text-gray-500">æš‚æ— ç¤ºä¾‹ã€‚</p>';
                document.getElementById('detail-examples-section').classList.remove('hidden'); // å³ä½¿æ²¡æœ‰ä¹Ÿè¦æ˜¾ç¤ºæ ‡é¢˜
            }


            // é¢˜è§£ä»£ç 
            document.getElementById('detail-solution-code').innerText = problem.code || '// æš‚æ— ä»£ç /ç¬”è®°';

            // ä»£ç ç¼–è¾‘å™¨
            const codeEditor = document.getElementById('detail-code-editor');
            codeEditor.value = problem.code || '// åœ¨è¿™é‡Œå†™ä½ çš„ä»£ç ...';
            codeEditor.problemId = problem.id; // å°†problemIdå…³è”åˆ°ç¼–è¾‘å™¨ï¼Œæ–¹ä¾¿ä¿å­˜

            // é»˜è®¤æ˜¾ç¤ºâ€œé¢˜ç›®â€tab
            showDetailTab('problem');
        }

        // è¯¦æƒ…é¡µtabåˆ‡æ¢
        function showDetailTab(tabName) {
            document.querySelectorAll('.detail-tab-button').forEach(btn => btn.classList.remove('active'));
            document.querySelectorAll('[id^="detail-tab-content-"]').forEach(content => content.classList.add('hidden'));

            document.getElementById(`tab-btn-${tabName}`).classList.add('active');
            document.getElementById(`detail-tab-content-${tabName}`).classList.remove('hidden');
        }

        // ä¿å­˜ç¼–è¾‘å™¨ä»£ç åˆ°æ•°æ®
        function saveCodeChanges() {
            if (currentProblemIdInDetail) {
                const problem = problems.find(p => p.id === currentProblemIdInDetail);
                if (problem) {
                    const editorContent = document.getElementById('detail-code-editor').value;
                    if (editorContent !== problem.code) { // ä»…åœ¨å†…å®¹æœ‰å˜åŒ–æ—¶æ›´æ–°
                        problem.code = editorContent;
                        saveData(); // ä¿å­˜åˆ° localStorage
                        // console.log(`Code for problem ${problem.id} saved.`);
                    }
                }
            }
        }

        // æ¨¡æ‹Ÿè¿è¡Œä»£ç 
        function simulateRunCode() {
            alert('è¿è¡Œä»£ç åŠŸèƒ½éœ€è¦åç«¯æ”¯æŒï¼Œç›®å‰ä¸ºæ¨¡æ‹Ÿã€‚æ‚¨çš„ä»£ç å·²ä¿å­˜åˆ°æœ¬åœ°ã€‚');
            saveCodeChanges(); // æ¨¡æ‹Ÿè¿è¡Œå‰å…ˆä¿å­˜
            // å¯ä»¥åœ¨è¿™é‡Œæ·»åŠ ä¸€äº›ç®€å•çš„å‰ç«¯éªŒè¯æˆ–è¾“å‡ºï¼Œä½†æ— æ³•çœŸæ­£æ‰§è¡Œä»£ç 
            console.log("Simulating run for code:", document.getElementById('detail-code-editor').value);
        }

        // æ¨¡æ‹Ÿæäº¤ä»£ç 
        function simulateSubmitCode() {
            alert('æäº¤ä»£ç åŠŸèƒ½éœ€è¦åç«¯æ”¯æŒï¼Œç›®å‰ä¸ºæ¨¡æ‹Ÿã€‚æ‚¨çš„ä»£ç å·²ä¿å­˜åˆ°æœ¬åœ°ã€‚');
            saveCodeChanges(); // ç¡®ä¿æäº¤å‰ä¿å­˜ä»£ç 
            console.log("Simulating submit for code:", document.getElementById('detail-code-editor').value);
        }

        // --- 7. å¿ƒå¾—æ„Ÿæ‚Ÿé¡µé€»è¾‘ ---
        let currentInsightFilterTag = 'all';
        let currentInsightFilterDate = '';

        function renderInsights(filterTag = currentInsightFilterTag) {
            currentInsightFilterTag = filterTag;
            currentInsightFilterDate = document.getElementById('insight-filter-date').value;

            // æ¸²æŸ“ç­›é€‰æ ‡ç­¾
            const filterTagContainer = document.getElementById('insight-filter-tags');
            filterTagContainer.innerHTML = '';
            tags.forEach(tag => {
                const isActive = currentInsightFilterTag === tag ? 'bg-blue-600 text-white' : 'bg-gray-200 hover:bg-gray-300';
                filterTagContainer.innerHTML += `<button class="tag-button ${isActive} px-3 py-1 rounded-full text-sm transition" onclick="renderInsights('${tag}')">${tag}</button>`;
            });

            let filteredInsights = insights.filter(i => {
                const matchTag = currentInsightFilterTag === 'all' || i.tags.includes(currentInsightFilterTag);
                const matchDate = !currentInsightFilterDate || i.date === currentInsightFilterDate;
                return matchTag && matchDate;
            }).sort((a, b) => new Date(b.date) - new Date(a.date)); // æŒ‰æ—¥æœŸå€’åº

            const grid = document.getElementById('insights-grid');
            grid.innerHTML = filteredInsights.map(i => `
                <div class="bg-white rounded-lg shadow-sm border border-gray-100 p-6 flex flex-col justify-between hover:shadow-md transition cursor-pointer" onclick="showInsightDetailModal(${i.id})">
                    <div>
                        <h3 class="text-xl font-semibold text-gray-800 mb-2">${i.title}</h3>
                        <p class="text-sm text-gray-500 mb-3">${i.date}</p>
                        <div class="flex flex-wrap gap-1 mb-4">
                            ${i.tags.map(t => `<span class="bg-gray-100 px-2 py-1 rounded text-xs text-gray-600">${t}</span>`).join('')}
                        </div>
                        <div class="prose max-w-none text-gray-700 overflow-hidden text-ellipsis line-clamp-3 mb-4">
                            ${marked.parse(i.content || '').substring(0, 150)}...
                        </div>
                    </div>
                    <div class="flex justify-end mt-4">
                        <button onclick="deleteInsight(${i.id}); event.stopPropagation();" class="text-red-500 hover:text-red-700 text-sm">åˆ é™¤</button>
                    </div>
                </div>
            `).join('');

            document.getElementById('no-insights-message').classList.toggle('hidden', filteredInsights.length > 0);
        }

        function clearInsightFilters() {
            document.getElementById('insight-filter-date').value = '';
            renderInsights('all');
        }

        function deleteInsight(id) {
            if(confirm('ç¡®å®šåˆ é™¤è¿™æ¡å¿ƒå¾—æ„Ÿæ‚Ÿå—ï¼Ÿ')) {
                insights = insights.filter(i => i.id !== id);
                saveData();
                renderInsights(currentInsightFilterTag);
            }
        }


        // --- 8. èµ„æºé¡µé€»è¾‘ ---
        function renderResources() {
            const list = document.getElementById('resources-list');
            list.innerHTML = '';

            if (resources.length === 0) {
                document.getElementById('no-resources-message').classList.remove('hidden');
                return;
            } else {
                document.getElementById('no-resources-message').classList.add('hidden');
            }

            resources.sort((a, b) => new Date(b.date) - new Date(a.date)); // æŒ‰æ—¥æœŸå€’åº
            list.innerHTML = resources.map(r => `
                <tr class="hover:bg-gray-50">
                    <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">${r.title}</td>
                    <td class="px-6 py-4 text-sm text-blue-600 hover:underline"><a href="${r.url}" target="_blank" rel="noopener noreferrer" class="truncate block max-w-[200px]">${r.url}</a></td>
                    <td class="px-6 py-4 text-sm text-gray-500">${r.description ? marked.parse(r.description).replace(/(<([^>]+)>)/gi, "").substring(0, 100) + (r.description.length > 100 ? '...' : '') : 'æ— æè¿°'}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${r.date}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm">
                        <button onclick="deleteResource(${r.id})" class="text-red-500 hover:text-red-700">åˆ é™¤</button>
                    </td>
                </tr>
            `).join('');
        }

        function deleteResource(id) {
            if(confirm('ç¡®å®šåˆ é™¤è¿™æ¡èµ„æºè®°å½•å—ï¼Ÿ')) {
                resources = resources.filter(r => r.id !== id);
                saveData();
                renderResources();
            }
        }

        // --- 9. æ¨¡æ€æ¡†åŠè¡¨å•å¤„ç† ---
        let selectedTagsForNewProblem = []; // ç”¨äºå­˜å‚¨æ–°é¢˜ç›®é€‰æ‹©çš„æ ‡ç­¾
        let selectedTagsForNewInsight = []; // ç”¨äºå­˜å‚¨æ–°æ„Ÿæ‚Ÿé€‰æ‹©çš„æ ‡ç­¾
        let newProblemExamples = []; // ä¸´æ—¶å­˜å‚¨æ–°é¢˜ç›®çš„ç¤ºä¾‹

        // --- æ·»åŠ é¢˜ç›®æ¨¡æ€æ¡† ---
        function showAddModal() {
            document.getElementById('add-modal').classList.remove('hidden');
            document.getElementById('inp-date').valueAsDate = new Date(); // é»˜è®¤ä»Šå¤©
            selectedTagsForNewProblem = []; // é‡ç½®å·²é€‰æ ‡ç­¾
            newProblemExamples = []; // é‡ç½®ç¤ºä¾‹
            renderSelectedTags(selectedTagsForNewProblem, 'selected-tags-display');
            renderTagDropdownOptions(selectedTagsForNewProblem, 'inp-tags-input', 'tag-dropdown'); // åˆ·æ–°æ ‡ç­¾ä¸‹æ‹‰åˆ—è¡¨
            document.getElementById('inp-tags-input').value = ''; // æ¸…ç©ºè¾“å…¥æ¡†
            document.getElementById('example-fields-container').innerHTML = '<p class="text-xs text-gray-500">ç‚¹å‡» "+ æ·»åŠ ç¤ºä¾‹" æŒ‰é’®æ¥æ·»åŠ è¾“å…¥/è¾“å‡ºç¤ºä¾‹ã€‚</p>';
        }

        function closeAddModal() {
            document.getElementById('add-modal').classList.add('hidden');
            document.getElementById('add-form').reset();
            selectedTagsForNewProblem = []; 
            newProblemExamples = [];
            renderSelectedTags(selectedTagsForNewProblem, 'selected-tags-display');
            document.getElementById('example-fields-container').innerHTML = '<p class="text-xs text-gray-500">ç‚¹å‡» "+ æ·»åŠ ç¤ºä¾‹" æŒ‰é’®æ¥æ·»åŠ è¾“å…¥/è¾“å‡ºç¤ºä¾‹ã€‚</p>';
        }

        function addExampleFields() {
            // ç¡®ä¿ç§»é™¤åˆå§‹æç¤º
            const container = document.getElementById('example-fields-container');
            if (container.querySelector('p.text-xs')) {
                container.innerHTML = ''; 
            }

            const exampleIndex = newProblemExamples.length;
            newProblemExamples.push({ input: '', output: '' }); // æ·»åŠ ç©ºç¤ºä¾‹åˆ°æ•°ç»„

            const exampleDiv = document.createElement('div');
            exampleDiv.className = 'flex flex-col gap-2 p-3 border border-gray-200 rounded-md bg-white relative';
            exampleDiv.innerHTML = `
                <div class="absolute top-1 right-2">
                    <button type="button" onclick="removeExampleFields(this, ${exampleIndex})" class="text-red-500 hover:text-red-700 text-lg">&times;</button>
                </div>
                <label class="block text-xs font-medium text-gray-700">ç¤ºä¾‹ ${exampleIndex + 1} è¾“å…¥:</label>
                <textarea class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm p-1 text-sm font-mono" rows="2" 
                    oninput="newProblemExamples[${exampleIndex}].input = this.value"></textarea>
                <label class="block text-xs font-medium text-gray-700">ç¤ºä¾‹ ${exampleIndex + 1} è¾“å‡º:</label>
                <textarea class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm p-1 text-sm font-mono" rows="2" 
                    oninput="newProblemExamples[${exampleIndex}].output = this.value"></textarea>
            `;
            container.appendChild(exampleDiv);
        }

        function removeExampleFields(button, indexToRemove) {
            button.closest('div.flex.flex-col').remove(); // ç§»é™¤HTMLå…ƒç´ 
            newProblemExamples.splice(indexToRemove, 1); // ä»æ•°ç»„ä¸­ç§»é™¤

            // é‡æ–°ç´¢å¼•å¹¶æ›´æ–°äº‹ä»¶ç›‘å¬ï¼Œæˆ–è€…ç®€åŒ–ï¼šåªç§»é™¤ä¸é‡æ–°ç´¢å¼•ï¼Œæäº¤æ—¶æ”¶é›†
            // å¯¹äºå½“å‰è¿™ç§ç®€å•åœºæ™¯ï¼Œç›´æ¥ç§»é™¤æ˜¯OKçš„ï¼Œå› ä¸ºæäº¤æ—¶ä¼šéå†å®¹å™¨
            // æˆ–è€…æ›´å¥å£®çš„æ–¹å¼æ˜¯ï¼Œé‡æ–°æ¸²æŸ“æ•´ä¸ªå®¹å™¨ï¼Œä½†ä¼šä¸¢å¤±ç”¨æˆ·è¾“å…¥
            // æœ€å¥½çš„æ–¹å¼æ˜¯ï¼šåœ¨æäº¤æ—¶éå†å®¹å™¨ï¼Œè€Œä¸æ˜¯ä¾èµ–newProblemExamplesæ•°ç»„
            // è¿™é‡Œä¸ºäº†ç®€å•ï¼Œç»§ç»­ä¾èµ–newProblemExamplesï¼Œä½†åœ¨ç§»é™¤æ—¶éœ€è¦æ³¨æ„ç´¢å¼•é—®é¢˜
            // å®é™…ä¸Šï¼Œæ›´ç®€å•çš„åšæ³•æ˜¯ï¼Œåªè®©newProblemExampleså­˜æ”¾idï¼Œç„¶åæ¯æ¬¡ä¿®æ”¹éƒ½æ‰¾åˆ°å¯¹åº”idçš„å…ƒç´ 
            // æˆ–è€…ï¼Œå½“åˆ é™¤æ—¶ï¼Œç›´æ¥æ‰¾åˆ°å¯¹åº”çš„å…ƒç´ ï¼Œç„¶ååˆ é™¤ã€‚
            // é‰´äºç›®å‰æ˜¯ç›´æ¥ç§»é™¤DOMï¼Œå¹¶ä»newProblemExamplesä¸­åˆ é™¤ï¼Œä½†DOMå…ƒç´ æœ¬èº«ä¸å¸¦æœ‰indexå±æ€§
            // é‡æ–°è®¾è®¡ä¸€ä¸‹removeExampleFieldsï¼šç›´æ¥é€šè¿‡DOMæ“ä½œæ¥ç§»é™¤ï¼Œå¹¶é‡æ–°ä»DOMä¸­æ„å»ºnewProblemExamples
            // ç®€åŒ–å¤„ç†ï¼šæ¯æ¬¡addExampleFieldsåªæ˜¯æ·»åŠ ï¼Œåˆ é™¤æ—¶ç›´æ¥remove DOMå…ƒç´ ã€‚æäº¤æ—¶å†éå†DOMæ”¶é›†
            collectAndSetNewProblemExamples(); // æ¯æ¬¡åˆ é™¤ååˆ·æ–°ä¸€ä¸‹newProblemExamplesï¼Œç¡®ä¿åŒæ­¥
            if (document.getElementById('example-fields-container').children.length === 0) {
                document.getElementById('example-fields-container').innerHTML = '<p class="text-xs text-gray-500">ç‚¹å‡» "+ æ·»åŠ ç¤ºä¾‹" æŒ‰é’®æ¥æ·»åŠ è¾“å…¥/è¾“å‡ºç¤ºä¾‹ã€‚</p>';
            }
        }

        // è¾…åŠ©å‡½æ•°ï¼Œç”¨äºåœ¨æäº¤å‰ä»DOMæ”¶é›†ç¤ºä¾‹
        function collectExamplesFromForm() {
            const examples = [];
            const exampleDivs = document.querySelectorAll('#example-fields-container > div');
            exampleDivs.forEach(div => {
                const input = div.querySelector('textarea:nth-of-type(1)').value;
                const output = div.querySelector('textarea:nth-of-type(2)').value;
                if (input.trim() || output.trim()) { // åªæ”¶é›†éç©ºç¤ºä¾‹
                    examples.push({ input: input, output: output });
                }
            });
            return examples;
        }


        document.getElementById('add-form').addEventListener('submit', function(e) {
            e.preventDefault();
            const examples = collectExamplesFromForm(); // æ”¶é›†ç¤ºä¾‹
            const newProblem = {
                id: getNextId(),
                title: document.getElementById('inp-title').value,
                difficulty: document.getElementById('inp-difficulty').value,
                date: document.getElementById('inp-date').value,
                tags: [...new Set(selectedTagsForNewProblem)], // ä½¿ç”¨ Set å»é‡
                desc: document.getElementById('inp-desc').value,
                examples: examples, // ä¿å­˜ç¤ºä¾‹
                code: document.getElementById('inp-code').value
            };
            problems.push(newProblem);
            saveData();
            closeAddModal();
            router('detail', newProblem.id); // åˆ›å»ºåè·³è½¬åˆ°æ–°é¢˜ç›®çš„è¯¦æƒ…é¡µ
        });

        // --- æ–°å»ºåˆ†ç±»æ¨¡æ€æ¡† ---
        function showAddTagModal() {
            document.getElementById('add-tag-modal').classList.remove('hidden');
            document.getElementById('inp-new-tag').value = ''; // æ¸…ç©ºè¾“å…¥æ¡†
        }

        function closeAddTagModal() {
            document.getElementById('add-tag-modal').classList.add('hidden');
            document.getElementById('add-tag-form').reset();
        }

        document.getElementById('add-tag-form').addEventListener('submit', function(e) {
            e.preventDefault();
            const newTag = document.getElementById('inp-new-tag').value.trim();
            if (newTag && !tags.includes(newTag)) {
                tags.push(newTag);
                saveData();
                closeAddTagModal();
                renderProblemList(currentProblemFilterTag); // åˆ·æ–°é¢˜åº“é¡µé¢çš„åˆ†ç±»æ ‡ç­¾
                renderTagDropdownOptions(selectedTagsForNewProblem, 'inp-tags-input', 'tag-dropdown'); // åˆ·æ–°æ·»åŠ é¢˜ç›®æ—¶çš„æ ‡ç­¾é€‰é¡¹
                renderTagDropdownOptions(selectedTagsForNewInsight, 'inp-insight-tags-input', 'insight-tag-dropdown'); // åˆ·æ–°æ·»åŠ æ„Ÿæ‚Ÿæ—¶çš„æ ‡ç­¾é€‰é¡¹
            } else if (tags.includes(newTag)) {
                alert('è¯¥åˆ†ç±»å·²å­˜åœ¨ï¼');
            }
        });

        // --- æ·»åŠ å¿ƒå¾—æ„Ÿæ‚Ÿæ¨¡æ€æ¡† ---
        function showAddInsightModal() {
            document.getElementById('add-insight-modal').classList.remove('hidden');
            document.getElementById('inp-insight-date').valueAsDate = new Date();
            selectedTagsForNewInsight = [];
            renderSelectedTags(selectedTagsForNewInsight, 'selected-insight-tags-display');
            renderTagDropdownOptions(selectedTagsForNewInsight, 'inp-insight-tags-input', 'insight-tag-dropdown');
            document.getElementById('inp-insight-tags-input').value = '';
        }

        function closeAddInsightModal() {
            document.getElementById('add-insight-modal').classList.add('hidden');
            document.getElementById('add-insight-form').reset();
            selectedTagsForNewInsight = [];
            renderSelectedTags(selectedTagsForNewInsight, 'selected-insight-tags-display');
        }

        document.getElementById('add-insight-form').addEventListener('submit', function(e) {
            e.preventDefault();
            const newInsight = {
                id: getNextId(),
                title: document.getElementById('inp-insight-title').value,
                date: document.getElementById('inp-insight-date').value,
                tags: [...new Set(selectedTagsForNewInsight)],
                content: document.getElementById('inp-insight-content').value
            };
            insights.push(newInsight);
            saveData();
            closeAddInsightModal();
            router('insights'); // æ·»åŠ åè·³è½¬åˆ°å¿ƒå¾—æ„Ÿæ‚Ÿé¡µ
        });

        // å¿ƒå¾—æ„Ÿæ‚Ÿè¯¦æƒ…æ¨¡æ€æ¡†
        function showInsightDetailModal(id) {
            const insight = insights.find(i => i.id === id);
            if (!insight) return;

            document.getElementById('insight-detail-title').innerText = insight.title;
            document.getElementById('insight-detail-date').innerText = insight.date;
            document.getElementById('insight-detail-tags').innerHTML = insight.tags.map(t => 
                `<span class="bg-gray-100 px-2 py-1 rounded text-xs text-gray-600">${t}</span>`
            ).join('');
            document.getElementById('insight-detail-content').innerHTML = marked.parse(insight.content || 'æš‚æ— å†…å®¹');
            
            document.getElementById('insight-detail-modal').classList.remove('hidden');
        }

        function closeInsightDetailModal() {
            document.getElementById('insight-detail-modal').classList.add('hidden');
        }

        // --- æ·»åŠ èµ„æºæ¨¡æ€æ¡† ---
        function showAddResourceModal() {
            document.getElementById('add-resource-modal').classList.remove('hidden');
            document.getElementById('inp-resource-date').valueAsDate = new Date();
        }

        function closeAddResourceModal() {
            document.getElementById('add-resource-modal').classList.add('hidden');
            document.getElementById('add-resource-form').reset();
        }

        document.getElementById('add-resource-form').addEventListener('submit', function(e) {
            e.preventDefault();
            const newResource = {
                id: getNextId(),
                title: document.getElementById('inp-resource-title').value,
                url: document.getElementById('inp-resource-url').value,
                description: document.getElementById('inp-resource-desc').value,
                date: document.getElementById('inp-resource-date').value
            };
            resources.push(newResource);
            saveData();
            closeAddResourceModal();
            router('resources'); // æ·»åŠ åè·³è½¬åˆ°èµ„æºé¡µ
        });

        // --- æ ‡ç­¾ä¸‹æ‹‰é€‰æ‹©é€šç”¨é€»è¾‘ ---
        let tagDropdownTimeout;

        function showTagDropdown() { // For problems
            clearTimeout(tagDropdownTimeout);
            renderTagDropdownOptions(selectedTagsForNewProblem, 'inp-tags-input', 'tag-dropdown');
            document.getElementById('tag-dropdown').classList.remove('hidden');
        }

        function hideTagDropdownDelayed() { // For problems
            tagDropdownTimeout = setTimeout(() => {
                document.getElementById('tag-dropdown').classList.add('hidden');
            }, 200); 
        }

        function showInsightTagDropdown() { // For insights
            clearTimeout(tagDropdownTimeout);
            renderTagDropdownOptions(selectedTagsForNewInsight, 'inp-insight-tags-input', 'insight-tag-dropdown');
            document.getElementById('insight-tag-dropdown').classList.remove('hidden');
        }

        function hideInsightTagDropdownDelayed() { // For insights
            tagDropdownTimeout = setTimeout(() => {
                document.getElementById('insight-tag-dropdown').classList.add('hidden');
            }, 200);
        }

        // é€šç”¨æ¸²æŸ“å·²é€‰æ ‡ç­¾
        function renderSelectedTags(selectedArr, displayElementId) {
            const displayDiv = document.getElementById(displayElementId);
            displayDiv.innerHTML = selectedArr.map(tag => `
                <span class="selected-tag">
                    ${tag}
                    <button type="button" onclick="removeSelectedTagFromList('${tag}', '${displayElementId}')">x</button>
                </span>
            `).join('');
        }

        // é€šç”¨ç§»é™¤å·²é€‰æ ‡ç­¾
        function removeSelectedTagFromList(tagToRemove, displayElementId) {
            if (displayElementId === 'selected-tags-display') {
                selectedTagsForNewProblem = selectedTagsForNewProblem.filter(tag => tag !== tagToRemove);
                renderSelectedTags(selectedTagsForNewProblem, displayElementId);
                renderTagDropdownOptions(selectedTagsForNewProblem, 'inp-tags-input', 'tag-dropdown');
                document.getElementById('inp-tags-input').focus();
            } else if (displayElementId === 'selected-insight-tags-display') {
                selectedTagsForNewInsight = selectedTagsForNewInsight.filter(tag => tag !== tagToRemove);
                renderSelectedTags(selectedTagsForNewInsight, displayElementId);
                renderTagDropdownOptions(selectedTagsForNewInsight, 'inp-insight-tags-input', 'insight-tag-dropdown');
                document.getElementById('inp-insight-tags-input').focus();
            }
        }


        // é€šç”¨æ¸²æŸ“ä¸‹æ‹‰æ ‡ç­¾é€‰é¡¹
        function renderTagDropdownOptions(selectedArr, inputElementId, dropdownElementId) {
            const dropdown = document.getElementById(dropdownElementId);
            const inputValue = document.getElementById(inputElementId).value.toLowerCase();
            
            const availableTags = tags.filter(tag => 
                !selectedArr.includes(tag) && tag.toLowerCase().includes(inputValue)
            );

            if (availableTags.length === 0 && inputValue.length > 0 && !tags.includes(inputValue)) {
                dropdown.innerHTML = `
                    <div class="tag-dropdown-item bg-blue-100 hover:bg-blue-200" onmousedown="addTagAndSelectNew('${inputValue}', '${inputElementId}', '${dropdownElementId}')">
                        <span>åˆ›å»ºæ–°æ ‡ç­¾: "${inputValue}"</span>
                        <span class="text-blue-600">+</span>
                    </div>
                `;
            } else {
                dropdown.innerHTML = availableTags.map(tag => `
                    <div class="tag-dropdown-item" onmousedown="addTagToSelected('${tag}', '${inputElementId}')">${tag}</div>
                `).join('');
            }
            if (dropdown.innerHTML === '') {
                dropdown.classList.add('hidden');
            } else {
                dropdown.classList.remove('hidden');
            }
        }

        // é€šç”¨æ·»åŠ æ ‡ç­¾åˆ°å·²é€‰åˆ—è¡¨
        function addTagToSelected(tag, inputElementId) {
            if (inputElementId === 'inp-tags-input') {
                if (!selectedTagsForNewProblem.includes(tag)) {
                    selectedTagsForNewProblem.push(tag);
                    renderSelectedTags(selectedTagsForNewProblem, 'selected-tags-display');
                }
                document.getElementById('inp-tags-input').value = '';
                renderTagDropdownOptions(selectedTagsForNewProblem, 'inp-tags-input', 'tag-dropdown');
                document.getElementById('inp-tags-input').focus();
            } else if (inputElementId === 'inp-insight-tags-input') {
                if (!selectedTagsForNewInsight.includes(tag)) {
                    selectedTagsForNewInsight.push(tag);
                    renderSelectedTags(selectedTagsForNewInsight, 'selected-insight-tags-display');
                }
                document.getElementById('inp-insight-tags-input').value = '';
                renderTagDropdownOptions(selectedTagsForNewInsight, 'inp-insight-tags-input', 'insight-tag-dropdown');
                document.getElementById('inp-insight-tags-input').focus();
            }
        }

        // é€šç”¨åˆ›å»ºæ–°æ ‡ç­¾å¹¶é€‰æ‹©
        function addTagAndSelectNew(newTagValue, inputElementId, dropdownElementId) {
            const trimmedTag = newTagValue.trim();
            if (trimmedTag && !tags.includes(trimmedTag)) {
                tags.push(trimmedTag);
                saveData(); // ä¿å­˜æ–°æ ‡ç­¾
            }
            addTagToSelected(trimmedTag, inputElementId);
            document.getElementById(inputElementId).value = '';
            renderTagDropdownOptions(selectedTagsForNewProblem, 'inp-tags-input', 'tag-dropdown'); // åˆ·æ–°ä¸¤ä¸ªä¸‹æ‹‰åˆ—è¡¨
            renderTagDropdownOptions(selectedTagsForNewInsight, 'inp-insight-tags-input', 'insight-tag-dropdown');
        }

        document.getElementById('inp-tags-input').addEventListener('input', () => renderTagDropdownOptions(selectedTagsForNewProblem, 'inp-tags-input', 'tag-dropdown'));
        document.getElementById('inp-insight-tags-input').addEventListener('input', () => renderTagDropdownOptions(selectedTagsForNewInsight, 'inp-insight-tags-input', 'insight-tag-dropdown'));


        // --- 10. å·¥å…·å‡½æ•° & äº‹ä»¶å¤„ç† ---
        function getDifficultyClass(diff) {
            if (diff === 'Easy') return 'tag-easy';
            if (diff === 'Medium') return 'tag-medium';
            return 'tag-hard';
        }
        function getChineseDifficulty(diff) {
            if (diff === 'Easy') return 'ç®€å•';
            if (diff === 'Medium') return 'ä¸­ç­‰';
            if (diff === 'Hard') return 'å›°éš¾';
            return diff; // Fallback
        }

        // HTMLè½¬ä¹‰å·¥å…·ï¼Œç”¨äºæ˜¾ç¤ºç”¨æˆ·è¾“å…¥çš„å†…å®¹
        function escapeHtml(unsafe) {
            return unsafe
                .replace(/&/g, "&amp;")
                .replace(/</g, "&lt;")
                .replace(/>/g, "&gt;")
                .replace(/"/g, "&quot;")
                .replace(/'/g, "&#039;");
        }


        // --- åˆå§‹åŒ– ---
        // é¢„ç½®ä¸€äº›å‡æ•°æ®ï¼Œå¦‚æœLocalStorageä¸ºç©º
        if (problems.length === 0 && insights.length === 0 && resources.length === 0) {
            problems = [
                { id: getNextId(), title: "ä¸¤æ•°ä¹‹å’Œ", difficulty: "Easy", date: "2023-10-01", tags: ["æ•°ç»„", "å“ˆå¸Œè¡¨"], desc: "ç»™å®šä¸€ä¸ªæ•´æ•°æ•°ç»„ `nums` å’Œä¸€ä¸ªæ•´æ•°ç›®æ ‡å€¼ `target`ï¼Œè¯·ä½ åœ¨è¯¥æ•°ç»„ä¸­æ‰¾å‡ºå’Œä¸ºç›®æ ‡å€¼ `target` çš„é‚£ä¸¤ä¸ªæ•´æ•°ï¼Œå¹¶è¿”å›å®ƒä»¬çš„æ•°ç»„ä¸‹æ ‡ã€‚\n\nä½ å¯ä»¥å‡è®¾æ¯ç§è¾“å…¥åªä¼šå¯¹åº”ä¸€ä¸ªç­”æ¡ˆã€‚ä½†æ˜¯ï¼Œæ•°ç»„ä¸­åŒä¸€ä¸ªå…ƒç´ åœ¨ç­”æ¡ˆé‡Œä¸èƒ½é‡å¤å‡ºç°ã€‚", code: "class Solution {\n    public int[] twoSum(int[] nums, int target) {\n        // ä½ çš„è§£é¢˜ä»£ç \n        // è¿™æ˜¯ä¸€ä¸ªç¤ºä¾‹ä»£ç \n        for (int i = 0; i < nums.length; i++) {\n            for (int j = i + 1; j < nums.length; j++) {\n                if (nums[i] + nums[j] == target) {\n                    return new int[]{i, j};\n                }\n            }\n        }\n        return new int[]{};\n    }\n}", examples: [{input: "nums = [2,7,11,15], target = 9", output: "[0,1]"}, {input: "nums = [3,2,4], target = 6", output: "[1,2]"}] },
                { id: getNextId(), title: "ä¸¤æ•°ç›¸åŠ ", difficulty: "Medium", date: "2023-10-02", tags: ["é“¾è¡¨", "æ•°å­¦"], desc: "ç»™å‡ºä¸¤ä¸ª **éç©º** çš„é“¾è¡¨ç”¨æ¥è¡¨ç¤ºä¸¤ä¸ªéè´Ÿçš„æ•´æ•°ã€‚å®ƒä»¬æ¯ä½æ•°å­—éƒ½æ˜¯æŒ‰ç…§ **é€†åº** æ–¹å¼å­˜å‚¨çš„ï¼Œå¹¶ä¸”æ¯ä¸ªèŠ‚ç‚¹åªèƒ½å­˜å‚¨ **ä¸€ä½** æ•°å­—ã€‚\n\nè¯·ä½ å°†ä¸¤ä¸ªæ•°ç›¸åŠ ï¼Œå¹¶ä»¥ç›¸åŒå½¢å¼è¿”å›ä¸€ä¸ªæ–°é“¾è¡¨ã€‚", code: "// ä»£ç å¾…å®Œæˆ", examples: [{input: "l1 = [2,4,3], l2 = [5,6,4]", output: "[7,0,8]"}] },
                { id: getNextId(), title: "å¯»æ‰¾ä¸¤ä¸ªæ­£åºæ•°ç»„çš„ä¸­ä½æ•°", difficulty: "Hard", date: new Date().toISOString().split('T')[0], tags: ["æ•°ç»„", "äºŒåˆ†æŸ¥æ‰¾"], desc: "ç»™å®šä¸¤ä¸ªå¤§å°åˆ†åˆ«ä¸º `m` å’Œ `n` çš„æ­£åºï¼ˆä»å°åˆ°å¤§ï¼‰æ•°ç»„ `nums1` å’Œ `nums2`ã€‚è¯·ä½ æ‰¾å‡ºå¹¶è¿”å›è¿™ä¸¤ä¸ªæ­£åºæ•°ç»„çš„ **ä¸­ä½æ•°** ã€‚", code: "class Solution {\n    public double findMedianSortedArrays(int[] nums1, int[] nums2) {\n        // ä½ çš„è§£é¢˜ä»£ç \n    }\n}", examples: [{input: "nums1 = [1,3], nums2 = [2]", output: "2.00000"}, {input: "nums1 = [1,2], nums2 = [3,4]", output: "2.50000"}] }
            ];
            insights = [
                { id: getNextId(), title: "åŠ¨æ€è§„åˆ’å­¦ä¹ å¿ƒå¾—", content: "### DP å…¥é—¨\nä»Šå¤©å­¦ä¹ äº†åŠ¨æ€è§„åˆ’çš„åŸºç¡€æ¦‚å¿µï¼Œä¸»è¦ç†è§£äº†é‡å å­é—®é¢˜å’Œæœ€ä¼˜å­ç»“æ„è¿™ä¸¤ä¸ªç‰¹æ€§ã€‚æ„Ÿè§‰è¿˜æ˜¯éœ€è¦å¤šåšé¢˜æ‰èƒ½çœŸæ­£æŒæ¡ã€‚\n\n#### å…³é”®ç‚¹:\n- **é‡å å­é—®é¢˜**: è®¡ç®—è¿‡ç¨‹ä¸­æœ‰é‡å¤çš„å­é—®é¢˜ã€‚\n- **æœ€ä¼˜å­ç»“æ„**: å¤§é—®é¢˜çš„æœ€ä¼˜è§£å¯ä»¥ç”±å­é—®é¢˜çš„æœ€ä¼˜è§£æ¨å¯¼è€Œæ¥ã€‚\n\næ¥ä¸‹æ¥è®¡åˆ’åšä¸€äº›ç®€å•çš„ DP é¢˜ç›®ã€‚", date: "2023-12-03", tags: ["åŠ¨æ€è§„åˆ’", "å­¦ä¹ ç¬”è®°"] },
                { id: getNextId(), title: "å¦‚ä½•é«˜æ•ˆåˆ·é¢˜", content: "æˆ‘è§‰å¾—åˆ·é¢˜æ•ˆç‡çš„å…³é”®åœ¨äºï¼š\n1. **ç†è§£é¢˜ç›®**ï¼šä¸æ˜¯çœ‹åˆ°é¢˜ç›®å°±å†™ï¼Œå…ˆç†è§£é¢˜æ„å’Œçº¦æŸã€‚\n2. **æ€è€ƒè§£æ³•**ï¼šå¤šå°è¯•å‡ ç§æ–¹æ³•ï¼Œå¹¶åˆ†ææ—¶é—´å¤æ‚åº¦ã€‚\n3. **æ€»ç»“å½’çº³**ï¼šæ¯é“é¢˜åšå®Œéƒ½è¦æ€»ç»“ï¼Œå†™ä¸‹è‡ªå·±çš„æ€è€ƒè¿‡ç¨‹å’Œè§£é¢˜æ€è·¯ã€‚", date: "2023-12-01", tags: ["å­¦ä¹ æ–¹æ³•"] }
            ];
            resources = [
                { id: getNextId(), title: "LeetCode å®˜ç½‘", url: "https://leetcode.cn/", description: "åˆ·ç®—æ³•é¢˜ç›®çš„é¦–é€‰å¹³å°ã€‚", date: "2023-11-20" },
                { id: getNextId(), title: "åŠ›æ‰£ï¼ˆLeetCodeï¼‰", url: "https://www.bilibili.com/video/BV1AE411B7h5", description: "Bç«™ä¸Šå¾ˆç«çš„ç®—æ³•è®²è§£ï¼Œé€‚åˆå…¥é—¨ã€‚", date: "2023-11-25" }
            ];
            saveData();
        }

        router('home'); // é»˜è®¤æ˜¾ç¤ºé¦–é¡µ

    </script>
</body>
</html>
